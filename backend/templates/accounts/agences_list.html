{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Gestion des Agences{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
{% endblock %}

{% block sidebar_menu %}
{% include 'dashboards/sidebars/admin_sidebar.html' %}
{% endblock %}

{% block page_content %}

{# URLs résolues par Django — le JS les lit depuis ces data-attributes #}
<div id="page-urls"
     data-create="{% url 'accounts:agence_create' %}"
     data-edit="{% url 'accounts:agence_edit' pk=0 %}"
     data-detail="{% url 'accounts:agence_detail' pk=0 %}"
     style="display:none;"></div>

<div class="page-header-with-actions">
    <div class="page-header">
        <h1 class="page-title">Gestion des Agences</h1>
        {{ agences.count }} agence{{ agences.count|pluralize }}
    </div>
    <div class="page-header-actions">
        <button class="export-btn export-btn-pdf" onclick="exportToPDF('agencesTable','agences.pdf')" title="Export PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button class="export-btn export-btn-excel" onclick="exportToExcel('agencesTable','agences.xlsx')" title="Export Excel">
            <i class="fas fa-file-excel"></i>
        </button>
        <button class="export-btn export-btn-csv" onclick="exportToCSV('agencesTable','agences.csv')" title="Export CSV">
            <i class="fas fa-file-csv"></i>
        </button>
        <button class="btn btn-primary" onclick="openModal('agenceFormModal')">
            <i class="fas fa-plus"></i> Nouveau
        </button>
    </div>
</div>

<div class="toolbar">
    <div class="toolbar-left">
        <div class="toolbar-search">
            <i class="fas fa-search"></i>
            <input type="text" id="tableSearch" placeholder="Rechercher...">
        </div>
        <div class="toolbar-filter">
            <select name="type" onchange="applyAgenceFilters()">
                <option value="">Tous types</option>
                <option value="SIEGE">Siège</option>
                <option value="REGIONALE">Régionale</option>
                <option value="LOCALE">Locale</option>
            </select>
        </div>
        <div class="toolbar-filter">
            <select name="direction" onchange="applyAgenceFilters()">
                <option value="">Toutes directions</option>
                {% for direction in directions %}
                <option value="{{ direction.id }}">{{ direction.nom }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="toolbar-filter">
            <select name="statut" onchange="applyAgenceFilters()">
                <option value="">Tous statuts</option>
                <option value="actif">Actives</option>
                <option value="inactif">Inactives</option>
            </select>
        </div>
    </div>
</div>

<div class="data-table-wrapper">
    <div class="data-table-body">
        <div class="table-responsive">
            <table class="table" id="agencesTable">
                <thead>
                <tr>
                    <th data-sortable style="width:50px;">#</th>
                    <th data-sortable>Nom</th>
                    <th data-sortable>Code</th>
                    <th data-sortable>Type</th>
                    <th data-sortable>Ville</th>
                    <th data-sortable>Direction</th>
                    <th data-sortable>Employés</th>
                    <th data-sortable>Statut</th>
                    <th style="width:120px;" class="actions-column">Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for agence in agences %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td style="font-weight:600;font-size:13px;">{{ agence.nom }}</td>
                    <td><span class="badge badge-success">{{ agence.code }}</span></td>
                    <td>
                        <span class="badge {% if agence.type_agence == 'SIEGE' %}badge-danger{% elif agence.type_agence == 'REGIONALE' %}badge-warning{% else %}badge-success{% endif %}" style="font-size:10px;">
                            {{ agence.get_type_agence_display }}
                        </span>
                    </td>
                    <td style="font-size:13px;">{{ agence.ville }}</td>
                    <td style="font-size:12px;">{{ agence.direction.nom|default:"-" }}</td>
                    <td style="font-size:12px;font-weight:600;">{{ agence.nombre_employes }}</td>
                    <td>
                        <span class="badge {% if agence.est_active %}badge-success{% else %}badge-danger{% endif %}">
                            {% if agence.est_active %}<i class="fas fa-check"></i>{% else %}<i class="fas fa-times"></i>{% endif %}
                        </span>
                    </td>
                    <td class="actions-cell">
                        <button class="action-btn action-btn-view" onclick="viewAgence({{ agence.id }})" title="Voir">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn action-btn-edit" onclick="editAgence({{ agence.id }})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn action-btn-delete"
                                onclick="confirmDelete({{ agence.id }},'{{ agence.nom }}','{% url 'accounts:agence_delete' agence.id %}')"
                                title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <i class="fas fa-building"></i>
                            <p>Aucune agence trouvée</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% include 'accounts/modals/agence_form.html' %}
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {

    // Lire les URLs résolues par Django (gère /agences/ ET /accounts/agences/)
    var urls = document.getElementById('page-urls').dataset;
    // urls.create  → ex: /agences/create/
    // urls.edit    → ex: /agences/0/edit/  (on remplace 0 par l'id réel)
    // urls.detail  → ex: /agences/0/

    function buildUrl(tpl, id) {
        return tpl.replace('/0/', '/' + id + '/');
    }

    initDataTable('agencesTable');

    // ── Soumission formulaire ──────────────────────────────
    var form = document.getElementById('agenceFormEl');
    if (!form) return;

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        var agId = document.getElementById('agence_id').value.trim();
        var url  = agId ? buildUrl(urls.edit, agId) : urls.create;

        var btn  = form.querySelector('[type="submit"]');
        var orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: new FormData(form),
        })
        .then(function (r) { return r.json(); })
        .then(function (data) {
            btn.disabled = false; btn.innerHTML = orig;
            if (data.success) {
                showToast(data.message || 'Agence enregistrée', 'success');
                closeModal('agenceFormModal');
                setTimeout(function () { window.location.reload(); }, 700);
            } else {
                showToast(data.error || 'Erreur', 'error');
            }
        })
        .catch(function () {
            btn.disabled = false; btn.innerHTML = orig;
            showToast('Erreur réseau', 'error');
        });
    });
});

// ── Actions tableau ────────────────────────────────────────
function viewAgence(id) {
    var urls = document.getElementById('page-urls').dataset;
    window.location.href = urls.detail.replace('/0/', '/' + id + '/');
}

function editAgence(id) {
    var urls = document.getElementById('page-urls').dataset;
    var editUrl = urls.edit.replace('/0/', '/' + id + '/');

    fetch(editUrl)
        .then(function (r) { return r.json(); })
        .then(function (data) {
            document.getElementById('agence_id').value      = data.id             || '';
            document.getElementById('ag_nom').value         = data.nom            || '';
            document.getElementById('ag_code').value        = data.code           || '';
            document.getElementById('ag_type').value        = data.type_agence    || 'LOCALE';
            document.getElementById('ag_ville').value       = data.ville          || '';
            document.getElementById('ag_telephone').value   = data.telephone      || '';
            document.getElementById('ag_email').value       = data.email          || '';
            document.getElementById('ag_direction').value   = data.direction_id   || '';
            document.getElementById('ag_responsable').value = data.responsable_id || '';
            document.getElementById('ag_adresse').value     = data.adresse        || '';
            document.getElementById('agenceModalTitle').textContent = "Modifier l'agence";
            openModal('agenceFormModal');
        })
        .catch(function () { showToast('Impossible de charger les données', 'error'); });
}

function applyAgenceFilters() {
    var params = new URLSearchParams();
    document.querySelectorAll('.toolbar-filter select').forEach(function (sel) {
        if (sel.name && sel.value) params.append(sel.name, sel.value);
    });
    window.location.search = params.toString();
}
</script>
{% endblock %}