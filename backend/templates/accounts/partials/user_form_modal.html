<!-- Modal for Add/Edit User -->
<div class="modal-overlay" id="addUserModal">
    <div class="modal modal-large">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-user-plus"></i>
                <span id="modalTitle">Nouvel utilisateur</span>
            </div>
            <button class="modal-close" onclick="closeModal('addUserModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="userForm" method="POST" action="{% url 'accounts:user_create' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="user_id" name="id" value="">

            <div class="modal-body">
                <div class="form-grid">
                    <!-- Prénom -->
                    <div class="form-group">
                        <label for="prenom" class="form-label">
                            Prénom <span style="color: var(--accent-red);">*</span>
                        </label>
                        <input type="text" id="prenom" name="prenom" class="form-control" required>
                    </div>

                    <!-- Nom -->
                    <div class="form-group">
                        <label for="nom" class="form-label">
                            Nom <span style="color: var(--accent-red);">*</span>
                        </label>
                        <input type="text" id="nom" name="nom" class="form-control" required>
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label for="email" class="form-label">
                            Email <span style="color: var(--accent-red);">*</span>
                        </label>
                        <input type="email" id="email" name="email" class="form-control" required>
                    </div>

                    <!-- Téléphone -->
                    <div class="form-group">
                        <label for="telephone" class="form-label">Téléphone</label>
                        <input type="tel" id="telephone" name="telephone" class="form-control" placeholder="+226 70 12 34 56">
                    </div>

                    <!-- Type d'utilisateur -->
                    <div class="form-group">
                        <label for="type_utilisateur" class="form-label">
                            Type d'utilisateur <span style="color: var(--accent-red);">*</span>
                        </label>
                        <select id="type_utilisateur" name="type_utilisateur" class="form-control" required onchange="toggleUserFields(this.value)">
                            <option value="">Sélectionner...</option>
                            <option value="CLIENT">Client (Employé)</option>
                            <option value="CAISSIER">Caissier</option>
                            <option value="GESTIONNAIRE_RESTAURANT">Gestionnaire Restaurant</option>
                            <option value="SUPER_ADMIN">Super Administrateur</option>
                        </select>
                    </div>

                    <!-- Genre -->
                    <div class="form-group">
                        <label for="genre" class="form-label">Genre</label>
                        <select id="genre" name="genre" class="form-control">
                            <option value="">Non spécifié</option>
                            <option value="M">Masculin</option>
                            <option value="F">Féminin</option>
                        </select>
                    </div>

                    <!-- Date de naissance -->
                    <div class="form-group">
                        <label for="date_naissance" class="form-label">Date de naissance</label>
                        <input type="date" id="date_naissance" name="date_naissance" class="form-control">
                    </div>

                    <!-- Matricule (visible si CLIENT) -->
                    <div class="form-group" id="field_matricule" style="display: none;">
                        <label for="matricule" class="form-label">Matricule</label>
                        <input type="text" id="matricule" name="matricule" class="form-control">
                    </div>

                    <!-- Département -->
                    <div class="form-group" id="field_departement" style="display: none;">
                        <label for="departement" class="form-label">Département</label>
                        <input type="text" id="departement" name="departement" class="form-control">
                    </div>

                    <!-- Poste -->
                    <div class="form-group" id="field_poste" style="display: none;">
                        <label for="poste" class="form-label">Poste</label>
                        <input type="text" id="poste" name="poste" class="form-control">
                    </div>

                    <!-- Direction -->
                    <div class="form-group">
                        <label for="direction" class="form-label">Direction</label>
                        <select id="direction" name="direction" class="form-control">
                            <option value="">Aucune</option>
                            {% for direction in directions %}
                            <option value="{{ direction.id }}">{{ direction.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Agence -->
                    <div class="form-group">
                        <label for="agence" class="form-label">Agence</label>
                        <select id="agence" name="agence" class="form-control">
                            <option value="">Aucune</option>
                            {% for agence in agences %}
                            <option value="{{ agence.id }}">{{ agence.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Restaurant géré (visible si GESTIONNAIRE_RESTAURANT) -->
                    <div class="form-group" id="field_restaurant" style="display: none;">
                        <label for="restaurant_gere" class="form-label">Restaurant géré</label>
                        <select id="restaurant_gere" name="restaurant_gere" class="form-control">
                            <option value="">Aucun</option>
                            {% for restaurant in restaurants %}
                            <option value="{{ restaurant.id }}">{{ restaurant.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Mot de passe (uniquement création) -->
                    <div class="form-group" id="field_password">
                        <label for="password" class="form-label">
                            Mot de passe <span style="color: var(--accent-red);">*</span>
                        </label>
                        <div class="password-toggle">
                            <input type="password" id="password" name="password" class="form-control">
                            <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('password')">
                                <i class="fas fa-eye" id="password-icon"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Confirmer mot de passe -->
                    <div class="form-group" id="field_password2">
                        <label for="password2" class="form-label">
                            Confirmer mot de passe <span style="color: var(--accent-red);">*</span>
                        </label>
                        <input type="password" id="password2" name="password2" class="form-control">
                    </div>

                    <!-- Adresse (full width) -->
                    <div class="form-group form-grid-full">
                        <label for="adresse" class="form-label">Adresse</label>
                        <textarea id="adresse" name="adresse" class="form-control" rows="2"></textarea>
                    </div>

                    <!-- Photo de profil -->
                    <div class="form-group form-grid-full">
                        <label for="photo_profil" class="form-label">Photo de profil</label>
                        <input type="file" id="photo_profil" name="photo_profil" class="form-control" accept="image/*" onchange="previewImage(this, 'photoPreview')">
                        <img id="photoPreview" style="display: none; max-width: 150px; max-height: 150px; margin-top: 10px; border-radius: 8px;">
                    </div>

                    <!-- Statut -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="est_actif" name="est_actif" value="1" checked style="width: 18px; height: 18px; accent-color: var(--primary-green);">
                            <span class="form-label" style="margin: 0;">Utilisateur actif</span>
                        </label>
                    </div>

                    <!-- Vérifié -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="est_verifie" name="est_verifie" value="1" style="width: 18px; height: 18px; accent-color: var(--primary-green);">
                            <span class="form-label" style="margin: 0;">Compte vérifié</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('addUserModal')">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Toggle user type specific fields
function toggleUserFields(userType) {
    // Hide all conditional fields
    document.getElementById('field_matricule').style.display = 'none';
    document.getElementById('field_departement').style.display = 'none';
    document.getElementById('field_poste').style.display = 'none';
    document.getElementById('field_restaurant').style.display = 'none';

    // Show relevant fields
    if (userType === 'CLIENT') {
        document.getElementById('field_matricule').style.display = 'block';
        document.getElementById('field_departement').style.display = 'block';
        document.getElementById('field_poste').style.display = 'block';
    } else if (userType === 'GESTIONNAIRE_RESTAURANT') {
        document.getElementById('field_restaurant').style.display = 'block';
    }
}

// Toggle password visibility
function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-icon');

    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Form submission
document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Validate passwords match (if creating)
    const userId = document.getElementById('user_id').value;
    if (!userId) {
        const password = document.getElementById('password').value;
        const password2 = document.getElementById('password2').value;

        if (password !== password2) {
            showError('Les mots de passe ne correspondent pas');
            return;
        }
    }

    showLoading('Enregistrement en cours...');

    const formData = new FormData(this);
    const url = userId ? `/api/accounts/users/${userId}/` : this.action;
    const method = userId ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        hideLoading();

        if (response.ok) {
            showSuccess('Utilisateur enregistré avec succès');
            closeModal('addUserModal');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const data = await response.json();
            showError(data.message || 'Erreur lors de l\'enregistrement');
            displayFormErrors(this, data.errors);
        }
    } catch (error) {
        hideLoading();
        showError('Erreur de connexion');
        console.error(error);
    }
});
</script>