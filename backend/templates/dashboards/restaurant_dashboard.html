{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Tableau de bord — {{ restaurant.nom }}{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
/* ═══ Styles spécifiques au dashboard restaurant ═══════════════
   NB : Ces classes ne figurent pas dans les autres dashboards car
   elles sont propres à la zone de scan QR et aux cards de stats.
   ══════════════════════════════════════════════════════════════ */

.stat-card {
    display: flex;
    align-items: center;
    gap: 16px;
    background: white;
    border-radius: var(--border-radius, 10px);
    padding: 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,.07);
}

.stat-icon {
    width: 52px;
    height: 52px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
}

/* Zone de scan ─────────────────────────────────────────────── */
.scan-zone {
    background: linear-gradient(135deg, var(--primary-green, #28a745), #1e7e34);
    color: white;
    border-radius: 12px;
    padding: 28px 24px;
    text-align: center;
    box-shadow: 0 4px 16px rgba(40,167,69,.35);
}

.scan-input-wrap {
    display: flex;
    gap: 10px;
    margin-top: 18px;
}

.scan-input {
    flex: 1;
    padding: 11px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    color: #2d3748;
}

.scan-btn {
    padding: 11px 20px;
    background: white;
    color: var(--primary-green, #28a745);
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: opacity .2s;
    white-space: nowrap;
}
.scan-btn:hover  { opacity: .9; }
.scan-btn:disabled { opacity: .6; cursor: not-allowed; }

/* Résultat du scan ─────────────────────────────────────────── */
.result-box {
    display: none;
    margin-top: 14px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    text-align: left;
    line-height: 1.5;
}
.result-ok  { background: rgba(255,255,255,.2); border: 1px solid rgba(255,255,255,.5); color: white; }
.result-err { background: rgba(220,53,69,.25);  border: 1px solid rgba(220,53,69,.6);  color: #fff;  }

/* Card réservation ─────────────────────────────────────────── */
.res-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color, #e9ecef);
    transition: background .15s;
}
.res-card:last-child { border-bottom: none; }
.res-card:hover { background: var(--bg-light, #f8f9fa); }
</style>
{% endblock %}

{% block sidebar_menu %}
{% include 'dashboards/sidebars/restaurant_sidebar.html' %}
{% endblock %}

{% block page_content %}
<div id="page-urls"
     data-scan-url="{% url 'restaurants:valider_qr_code' %}"
     style="display:none;"></div>

<!-- ═══ En-tête ══════════════════════════════════════════════ -->
<div style="margin-bottom:24px;display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;">
    <div>
        <h1 style="font-size:22px;font-weight:700;color:var(--text-primary);margin:0;">
            <i class="fas fa-utensils" style="color:var(--primary-green);margin-right:10px;"></i>
            {{ restaurant.nom }}
        </h1>
        <p style="color:var(--text-muted);font-size:13px;margin:4px 0 0;">
            <i class="fas fa-map-marker-alt"></i> {{ restaurant.ville }} ·
            {{ aujourd_hui|date:"l d F Y" }}
        </p>
    </div>
    <div style="display:flex;gap:8px;">
        <a href="{% url 'restaurants:plannings_list' %}" class="btn btn-outline">
            <i class="fas fa-calendar-alt"></i> Plannings
        </a>
        <a href="{% url 'restaurants:menus_list' %}" class="btn btn-primary">
            <i class="fas fa-book-open"></i> Menus
        </a>
    </div>
</div>

<!-- ═══ Stats Cards ════════════════════════════════════════════ -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px;">

    <div class="stat-card" style="border-left:4px solid var(--primary-green);">
        <div class="stat-icon" style="background:#e8f5e9;">
            <i class="fas fa-ticket-alt" style="color:var(--primary-green);"></i>
        </div>
        <div>
            <div style="font-size:26px;font-weight:800;color:var(--primary-green);">{{ tickets_aujourd_hui }}</div>
            <div style="font-size:12px;color:var(--text-muted);">Tickets validés aujourd'hui</div>
        </div>
    </div>

    <div class="stat-card" style="border-left:4px solid #f59e0b;">
        <div class="stat-icon" style="background:#fff8e1;">
            <i class="fas fa-calendar-week" style="color:#f59e0b;"></i>
        </div>
        <div>
            <div style="font-size:26px;font-weight:800;color:#f59e0b;">{{ tickets_semaine }}</div>
            <div style="font-size:12px;color:var(--text-muted);">Cette semaine</div>
        </div>
    </div>

    <div class="stat-card" style="border-left:4px solid #2196f3;">
        <div class="stat-icon" style="background:#e3f2fd;">
            <i class="fas fa-clock" style="color:#2196f3;"></i>
        </div>
        <div>
            <div style="font-size:26px;font-weight:800;color:#2196f3;">{{ nb_attente }}</div>
            <div style="font-size:12px;color:var(--text-muted);">Réservations en attente</div>
        </div>
    </div>

    <div class="stat-card" style="border-left:4px solid var(--primary-green);">
        <div class="stat-icon" style="background:#e8f5e9;">
            <i class="fas fa-check-circle" style="color:var(--primary-green);"></i>
        </div>
        <div>
            <div style="font-size:26px;font-weight:800;color:var(--primary-green);">{{ nb_confirme }}</div>
            <div style="font-size:12px;color:var(--text-muted);">Réservations confirmées</div>
        </div>
    </div>
</div>

<!-- ═══ Scan + Menus + Graphe ══════════════════════════════════ -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">

    <!-- Zone de scan QR ──────────────────────────────────── -->
    <div class="scan-zone">
        <i class="fas fa-qrcode" style="font-size:48px;opacity:.9;"></i>
        <h2 style="font-size:18px;font-weight:700;margin:12px 0 4px;">Scanner un ticket</h2>
        <p style="font-size:13px;opacity:.8;margin:0;">Saisissez le code ou utilisez un lecteur QR</p>
        <div class="scan-input-wrap">
            <input type="text" id="qrInput" class="scan-input"
                   placeholder="Code QR ou saisie manuelle..."
                   autocomplete="off" autofocus>
            <button class="scan-btn" onclick="scannerQR()">
                <i class="fas fa-check"></i> Valider
            </button>
        </div>
        <div id="scanResult" class="result-box"></div>
    </div>

    <!-- Menus du jour ────────────────────────────────────── -->
    <div class="card" style="padding:20px;">
        <h3 style="font-size:15px;font-weight:700;margin:0 0 16px;color:var(--text-primary);">
            <i class="fas fa-book-open" style="color:var(--primary-green);margin-right:8px;"></i>
            Menus du jour
        </h3>
        {% for menu in menus_aujourd_hui %}
        <div style="border:1px solid var(--border-color);border-radius:8px;padding:12px;margin-bottom:10px;transition:background .15s;"
             onmouseover="this.style.background='var(--bg-light)'" onmouseout="this.style.background=''">
            <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">{{ menu.nom }}</div>
            {% if menu.plats %}
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;">{{ menu.plats }}</div>
            {% endif %}
            <div style="display:flex;gap:12px;font-size:12px;">
                {% if menu.quantite_restante is not None %}
                <span style="color:{% if menu.quantite_restante < 10 %}#dc3545{% else %}var(--primary-green){% endif %};font-weight:600;">
                    <i class="fas fa-layer-group"></i> {{ menu.quantite_restante }} restants
                </span>
                {% endif %}
                {% if menu.prix %}
                <span style="color:var(--text-muted);">
                    <i class="fas fa-tag"></i> {{ menu.prix|floatformat:0 }} FCFA
                </span>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div style="text-align:center;color:var(--text-muted);padding:24px;">
            <i class="fas fa-exclamation-circle" style="font-size:28px;display:block;margin-bottom:10px;opacity:.4;"></i>
            Aucun menu configuré pour aujourd'hui
        </div>
        {% endfor %}
    </div>
</div>

<!-- ═══ Réservations + Graphe journée ══════════════════════════ -->
<div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;">

    <!-- Réservations du jour ────────────────────────────── -->
    <div class="card" style="overflow:hidden;">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border-color);
                    display:flex;align-items:center;justify-content:space-between;">
            <h3 style="font-size:15px;font-weight:700;margin:0;">
                <i class="fas fa-list" style="color:var(--primary-green);margin-right:8px;"></i>
                Réservations du jour ({{ reservations_aujourd_hui.count }})
            </h3>
            <div style="display:flex;gap:6px;">
                <span class="badge badge-warning">{{ nb_attente }} att.</span>
                <span class="badge badge-success">{{ nb_confirme }} conf.</span>
            </div>
        </div>
        <div style="max-height:380px;overflow-y:auto;">
            {% for r in reservations_aujourd_hui %}
            <div class="res-card">
                <div style="width:36px;height:36px;border-radius:50%;background:var(--light-green);
                            display:flex;align-items:center;justify-content:center;
                            font-weight:700;color:var(--primary-green);font-size:13px;flex-shrink:0;">
                    {{ r.client.prenom.0 }}{{ r.client.nom.0 }}
                </div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:14px;color:var(--text-primary);">{{ r.client.get_full_name }}</div>
                    <div style="font-size:12px;color:var(--text-muted);">
                        {{ r.menu.nom }} · {{ r.client.matricule|default:"—" }}
                    </div>
                </div>
                <div>
                    {% if r.statut == 'EN_ATTENTE' %}
                    <span class="badge badge-warning" style="font-size:10px;">En attente</span>
                    {% elif r.statut == 'CONFIRME' %}
                    <span class="badge badge-success" style="font-size:10px;">Confirmé</span>
                    {% elif r.statut == 'TERMINE' %}
                    <span class="badge" style="background:#6c757d;color:white;font-size:10px;">Terminé</span>
                    {% else %}
                    <span class="badge badge-danger" style="font-size:10px;">Annulé</span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div style="text-align:center;padding:40px;color:var(--text-muted);">
                <i class="fas fa-calendar-times" style="font-size:32px;display:block;margin-bottom:12px;opacity:.3;"></i>
                Aucune réservation aujourd'hui
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Graphe statuts réservations + infos restaurant ──── -->
    <div style="display:flex;flex-direction:column;gap:16px;">

        <!-- Donut réservations -->
        <div class="card" style="padding:20px;">
            <h3 style="font-size:14px;font-weight:700;margin:0 0 12px;color:var(--text-primary);">
                <i class="fas fa-chart-pie" style="color:var(--primary-green);margin-right:6px;"></i>
                Réservations
            </h3>
            <canvas id="reservationsChart" height="160"></canvas>
        </div>

        <!-- Infos restaurant -->
        <div class="card" style="padding:20px;">
            <h3 style="font-size:14px;font-weight:700;margin:0 0 12px;color:var(--text-primary);">
                <i class="fas fa-info-circle" style="color:var(--primary-green);margin-right:6px;"></i>
                Mon restaurant
            </h3>
            <div style="font-size:13px;">
                {% if restaurant.telephone %}
                <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                    <i class="fas fa-phone" style="color:var(--primary-green);width:16px;"></i>
                    <span>{{ restaurant.telephone }}</span>
                </div>
                {% endif %}
                {% if restaurant.email %}
                <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                    <i class="fas fa-envelope" style="color:var(--primary-green);width:16px;"></i>
                    <span style="word-break:break-all;">{{ restaurant.email }}</span>
                </div>
                {% endif %}
                {% if restaurant.adresse %}
                <div style="display:flex;gap:8px;align-items:flex-start;">
                    <i class="fas fa-map-marker-alt" style="color:var(--primary-green);width:16px;margin-top:2px;"></i>
                    <span>{{ restaurant.adresse }}</span>
                </div>
                {% endif %}
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color);">
                    <span class="badge {% if restaurant.statut == 'ACTIF' %}badge-success{% else %}badge-warning{% endif %}">
                        {{ restaurant.get_statut_display }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
(function () {
    Chart.defaults.font.family = "'Inter','Segoe UI',sans-serif";
    Chart.defaults.font.size   = 12;

    /* ── Donut réservations : En attente / Confirmé / Terminé ── */
    var nbAttente  = {{ nb_attente|default:0 }};
    var nbConfirme = {{ nb_confirme|default:0 }};
    var nbAutres   = Math.max(0, {{ reservations_aujourd_hui.count|default:0 }} - nbAttente - nbConfirme);
    var total      = nbAttente + nbConfirme + nbAutres;

    new Chart(document.getElementById('reservationsChart'), {
        type: 'doughnut',
        data: {
            labels: ['En attente', 'Confirmées', 'Autres'],
            datasets: [{
                data: total > 0 ? [nbAttente, nbConfirme, nbAutres] : [1, 1, 1],
                backgroundColor: total > 0
                    ? ['#ffc107', '#28a745', '#6c757d']
                    : ['#e9ecef', '#e9ecef', '#e9ecef'],
                borderWidth: 2,
                borderColor: '#fff',
            }]
        },
        options: {
            responsive: true,
            cutout: '65%',
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
                tooltip: {
                    callbacks: {
                        label: function(c) {
                            return total > 0
                                ? ' ' + c.label + ' : ' + c.parsed
                                : ' Aucune réservation';
                        }
                    }
                }
            }
        }
    });

    /* ── Scanner QR ─────────────────────────────────────────── */
    var scanUrl = document.getElementById('page-urls').dataset.scanUrl;

    window.scannerQR = function () {
        var code = document.getElementById('qrInput').value.trim();
        if (!code) { showWarning('Veuillez saisir un code QR'); return; }

        var btn = document.querySelector('.scan-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        var fd = new FormData();
        fd.append('code', code);

        fetch(scanUrl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: fd })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                var box = document.getElementById('scanResult');
                box.style.display = 'block';
                if (d.valide) {
                    box.className = 'result-box result-ok';
                    box.innerHTML = '<i class="fas fa-check-circle"></i> ' + d.message +
                        '<br><small style="opacity:.85;">Ticket : ' + d.ticket_numero +
                        ' · ' + d.client + '</small>';
                    showSuccess(d.message);
                    document.getElementById('qrInput').value = '';
                    /* Mettre à jour le compteur tickets validés aujourd'hui */
                    var els = document.querySelectorAll('[data-tickets-count]');
                    if (els.length) els[0].textContent = parseInt(els[0].textContent || 0) + 1;
                } else {
                    box.className = 'result-box result-err';
                    box.innerHTML = '<i class="fas fa-times-circle"></i> ' + (d.error || 'Code invalide');
                    showError(d.error || 'Code invalide');
                }
                setTimeout(function() { box.style.display = 'none'; }, 5000);
            })
            .catch(function() { showError('Erreur réseau'); })
            .finally(function() {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Valider';
            });
    };

    /* Valider avec Entrée ─────────────────────────────────── */
    document.getElementById('qrInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') scannerQR();
    });
})();
</script>
{% endblock %}