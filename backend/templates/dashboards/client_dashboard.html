{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Tableau de bord - Client{% endblock %}

{% block sidebar_menu %}
<div class="nav-section">
    <div class="nav-section-title">Menu Principal</div>
    <ul class="nav-menu">
        <li class="nav-item">
            <a href="{% url 'accounts:client_dashboard' %}" class="nav-link active">
                <i class="fas fa-home"></i>
                <span class="nav-link-text">Tableau de bord</span>
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'accounts:client_tickets' %}" class="nav-link">
                <i class="fas fa-ticket-alt"></i>
                <span class="nav-link-text">Mes tickets</span>
                <span class="badge badge-success">{{ available_tickets_count }}</span>
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'accounts:client_qrcode' %}" class="nav-link">
                <i class="fas fa-qrcode"></i>
                <span class="nav-link-text">Mon QR Code</span>
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'accounts:client_history' %}" class="nav-link">
                <i class="fas fa-history"></i>
                <span class="nav-link-text">Historique</span>
            </a>
        </li>
    </ul>
</div>

<div class="nav-section">
    <div class="nav-section-title">Restaurants</div>
    <ul class="nav-menu">
        <li class="nav-item">
            <a href="{% url 'accounts:client_restaurants' %}" class="nav-link">
                <i class="fas fa-utensils"></i>
                <span class="nav-link-text">Restaurants</span>
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'accounts:client_menus' %}" class="nav-link">
                <i class="fas fa-clipboard-list"></i>
                <span class="nav-link-text">Menus</span>
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'accounts:client_reservations' %}" class="nav-link">
                <i class="fas fa-calendar-check"></i>
                <span class="nav-link-text">R√©servations</span>
            </a>
        </li>
    </ul>
</div>
{% endblock %}

{% block page_content %}
<div class="page-header">
    <h1 class="page-title">Bonjour, {{ user.first_name }} üëã</h1>
    <p class="page-subtitle">Voici un aper√ßu de votre activit√©</p>
</div>

<!-- Stats Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
    <!-- Tickets Disponibles -->
    <div class="card" style="border-left: 4px solid var(--primary-green);">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Tickets disponibles</div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary-green);">{{ available_tickets_count }}</div>
            </div>
            <div style="width: 50px; height: 50px; background: var(--light-green); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-ticket-alt" style="font-size: 22px; color: var(--primary-green);"></i>
            </div>
        </div>
    </div>

    <!-- Tickets Consomm√©s -->
    <div class="card" style="border-left: 4px solid var(--accent-red);">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Tickets consomm√©s</div>
                <div style="font-size: 28px; font-weight: 700; color: var(--text-primary);">{{ consumed_tickets_count }}</div>
            </div>
            <div style="width: 50px; height: 50px; background: var(--red-light); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-check-circle" style="font-size: 22px; color: var(--accent-red);"></i>
            </div>
        </div>
    </div>

    <!-- Solde -->
    <div class="card" style="border-left: 4px solid #ffc107;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Montant total</div>
                <div style="font-size: 28px; font-weight: 700; color: var(--text-primary);">{{ total_value }} FCFA</div>
            </div>
            <div style="width: 50px; height: 50px; background: #fff3cd; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-coins" style="font-size: 22px; color: #ffc107;"></i>
            </div>
        </div>
    </div>

    <!-- R√©servations -->
    <div class="card" style="border-left: 4px solid #17a2b8;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">R√©servations actives</div>
                <div style="font-size: 28px; font-weight: 700; color: var(--text-primary);">{{ active_reservations_count }}</div>
            </div>
            <div style="width: 50px; height: 50px; background: #d1ecf1; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-calendar-check" style="font-size: 22px; color: #17a2b8;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Two Column Layout -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-md);">
    <!-- QR Code Actuel -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-qrcode"></i> Mon QR Code du jour
        </div>
        <div style="text-align: center; padding: var(--spacing-lg);">
            {% if qr_code %}
                <div style="width: 200px; height: 200px; margin: 0 auto; background: var(--bg-secondary); border-radius: var(--border-radius); padding: var(--spacing-md); border: 2px dashed var(--border-color);">
                    {% if qr_code.qr_image %}
                        <img src="{{ qr_code.qr_image.url }}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;">
                    {% else %}
                        <i class="fas fa-qrcode" style="font-size: 120px; color: var(--text-muted);"></i>
                    {% endif %}
                </div>
                <div style="margin-top: var(--spacing-md);">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Expire dans</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--primary-green);" id="qrTimer">--:--</div>
                </div>
                <button class="btn btn-primary" style="margin-top: var(--spacing-md);" onclick="window.location.href='{% url 'client_qrcode' %}'">
                    <i class="fas fa-sync-alt"></i> R√©g√©n√©rer
                </button>
            {% else %}
                <div style="padding: var(--spacing-xl);">
                    <i class="fas fa-qrcode" style="font-size: 80px; color: var(--text-muted); margin-bottom: var(--spacing-md);"></i>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">Aucun QR code actif</p>
                    <button class="btn btn-primary" onclick="window.location.href='{% url 'accounts:client_qrcode' %}'">
                        <i class="fas fa-plus"></i> G√©n√©rer un QR Code
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Actions Rapides -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-bolt"></i> Actions rapides
        </div>
        <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
            <a href="{% url 'accounts:client_qrcode' %}" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-qrcode"></i>
                G√©n√©rer QR Code
            </a>
            <a href="{% url 'accounts:client_tickets' %}" class="btn btn-outline" style="width: 100%;">
                <i class="fas fa-ticket-alt"></i>
                Voir mes tickets
            </a>
            <a href="{% url 'accounts:client_menus' %}" class="btn btn-outline" style="width: 100%;">
                <i class="fas fa-clipboard-list"></i>
                Menus du jour
            </a>
            <a href="{% url 'accounts:client_reservations' %}" class="btn btn-outline" style="width: 100%;">
                <i class="fas fa-calendar-plus"></i>
                Nouvelle r√©servation
            </a>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="card" style="margin-top: var(--spacing-md);">
    <div class="card-header">
        <i class="fas fa-history"></i> Activit√© r√©cente
    </div>
    {% if recent_activity %}
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Restaurant</th>
                    <th>Menu</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for activity in recent_activity %}
                <tr>
                    <td>{{ activity.consumed_at|date:"d/m/Y H:i" }}</td>
                    <td>{{ activity.restaurant.name }}</td>
                    <td>{{ activity.menu_consumed.name|default:"N/A" }}</td>
                    <td><span class="badge badge-success">Consomm√©</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: var(--spacing-md);"></i>
            <p>Aucune activit√© r√©cente</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block dashboard_js %}
<script>
// QR Code Timer
{% if qr_code %}
const expiryTime = new Date("{{ qr_code.expires_at|date:'c' }}");
function updateTimer() {
    const now = new Date();
    const diff = expiryTime - now;

    if (diff <= 0) {
        document.getElementById('qrTimer').textContent = 'Expir√©';
        document.getElementById('qrTimer').style.color = 'var(--accent-red)';
        return;
    }

    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    document.getElementById('qrTimer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
}
updateTimer();
setInterval(updateTimer, 1000);
{% endif %}
</script>
{% endblock %}