{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Tableau de bord — Administration{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
{% endblock %}

{% block sidebar_menu %}
{% include 'dashboards/sidebars/admin_sidebar.html' %}
{% endblock %}

{% block page_content %}
<div class="page-header">
    <h1 class="page-title">Administration Générale</h1>
    <p class="page-subtitle">Vue d'ensemble du système LONAB — MUTRALO</p>
</div>

<!-- ═══ Stats Cards ════════════════════════════════════════════ -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--spacing-md);margin-bottom:var(--spacing-lg);">

    <div class="card" style="border-left:4px solid var(--primary-green);">
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
                <div style="color:var(--text-muted);font-size:11px;margin-bottom:4px;">EMPLOYÉS</div>
                <div style="font-size:24px;font-weight:700;color:var(--text-primary);">{{ total_employes }}</div>
                <div style="font-size:10px;color:var(--primary-green);margin-top:2px;">+{{ nouveaux_employes_mois }} ce mois</div>
            </div>
            <div style="width:45px;height:45px;background:var(--light-green);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <i class="fas fa-users" style="font-size:20px;color:var(--primary-green);"></i>
            </div>
        </div>
    </div>

    <div class="card" style="border-left:4px solid #6f42c1;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
                <div style="color:var(--text-muted);font-size:11px;margin-bottom:4px;">DIRECTIONS</div>
                <div style="font-size:24px;font-weight:700;color:var(--text-primary);">{{ total_directions }}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">{{ directions_actives }} actives</div>
            </div>
            <div style="width:45px;height:45px;background:#e7d9ff;border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <i class="fas fa-sitemap" style="font-size:20px;color:#6f42c1;"></i>
            </div>
        </div>
    </div>

    <div class="card" style="border-left:4px solid #17a2b8;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
                <div style="color:var(--text-muted);font-size:11px;margin-bottom:4px;">AGENCES</div>
                <div style="font-size:24px;font-weight:700;color:var(--text-primary);">{{ total_agences }}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">{{ agences_actives }} actives</div>
            </div>
            <div style="width:45px;height:45px;background:#d1ecf1;border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <i class="fas fa-building" style="font-size:20px;color:#17a2b8;"></i>
            </div>
        </div>
    </div>

    <div class="card" style="border-left:4px solid #ffc107;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
                <div style="color:var(--text-muted);font-size:11px;margin-bottom:4px;">RESTAURANTS</div>
                <div style="font-size:24px;font-weight:700;color:var(--text-primary);">{{ total_restaurants }}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">{{ restaurants_actifs }} actifs</div>
            </div>
            <div style="width:45px;height:45px;background:#fff3cd;border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <i class="fas fa-utensils" style="font-size:20px;color:#ffc107;"></i>
            </div>
        </div>
    </div>

    <div class="card" style="border-left:4px solid var(--accent-red);">
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
                <div style="color:var(--text-muted);font-size:11px;margin-bottom:4px;">TICKETS (MOIS)</div>
                <div style="font-size:24px;font-weight:700;color:var(--text-primary);">{{ tickets_vendus_mois }}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">{{ tickets_consommes_mois }} consommés</div>
            </div>
            <div style="width:45px;height:45px;background:var(--red-light);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <i class="fas fa-ticket-alt" style="font-size:20px;color:var(--accent-red);"></i>
            </div>
        </div>
    </div>

    <div class="card" style="border-left:4px solid #28a745;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
                <div style="color:var(--text-muted);font-size:11px;margin-bottom:4px;">REVENUS (MOIS)</div>
                <div style="font-size:24px;font-weight:700;color:var(--text-primary);">{{ revenu_mois|floatformat:0 }}</div>
                <div style="font-size:10px;color:var(--primary-green);margin-top:2px;">FCFA</div>
            </div>
            <div style="width:45px;height:45px;background:var(--light-green);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <i class="fas fa-coins" style="font-size:20px;color:var(--primary-green);"></i>
            </div>
        </div>
    </div>
</div>

<!-- ═══ Charts Row ═════════════════════════════════════════════ -->
<div style="display:grid;grid-template-columns:2fr 1fr;gap:var(--spacing-md);margin-bottom:var(--spacing-md);">

    <!-- Transactions récentes — graphe barres -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-chart-bar"></i> Transactions récentes — montants
        </div>
        <div style="padding:16px 20px;">
            <canvas id="transactionsChart" height="110"></canvas>
        </div>
    </div>

    <!-- Répartition par direction -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-chart-pie"></i> Employés par direction
        </div>
        <div style="padding:var(--spacing-md);">
            {% for d in directions_principales %}
            <div style="margin-bottom:var(--spacing-md);">
                <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px;">
                    <span style="font-weight:600;color:var(--text-primary);">{{ d.nom|truncatechars:22 }}</span>
                    <span style="color:var(--text-muted);font-weight:600;">{{ d.nombre_employes }}</span>
                </div>
                <div style="height:7px;background:var(--bg-secondary);border-radius:4px;overflow:hidden;">
                    <div style="height:100%;background:linear-gradient(90deg,var(--primary-green),#52c27a);border-radius:4px;width:{{ d.pourcentage|floatformat:0 }}%;transition:width .6s ease;"></div>
                </div>
            </div>
            {% empty %}
            <div style="text-align:center;color:var(--text-muted);padding:20px;font-size:13px;">Aucune direction</div>
            {% endfor %}

            <!-- Donut Chart directions -->
            <div style="margin-top:16px;">
                <canvas id="directionsDonut" height="160"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ═══ Tables Row ══════════════════════════════════════════════ -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md);">

    <!-- Dernières transactions -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-exchange-alt"></i> Dernières transactions
            <a href="{% url 'transactions:transactions_list' %}" class="btn btn-outline btn-sm" style="margin-left:auto;font-size:11px;">Voir tout</a>
        </div>
        {% if transactions_recentes %}
        <table class="table">
            <thead>
                <tr>
                    <th>N° Transaction</th>
                    <th>Client</th>
                    <th>Montant</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions_recentes|slice:":6" %}
                <tr>
                    <td style="font-size:11px;font-family:monospace;color:var(--primary-green);font-weight:700;">{{ t.numero_transaction|truncatechars:16 }}</td>
                    <td style="font-size:12px;">{{ t.client.get_full_name|truncatechars:20 }}</td>
                    <td style="font-size:12px;font-weight:600;">{{ t.montant_total|floatformat:0 }} <small style="color:var(--text-muted);">FCFA</small></td>
                    <td>
                        <span class="badge {% if t.statut == 'TERMINEE' %}badge-success{% elif t.statut == 'EN_ATTENTE' %}badge-warning{% else %}badge-danger{% endif %}" style="font-size:10px;">
                            {{ t.get_statut_display }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align:center;padding:var(--spacing-lg);color:var(--text-muted);font-size:13px;">
            <i class="fas fa-inbox" style="font-size:32px;display:block;margin-bottom:8px;opacity:.4;"></i>
            Aucune transaction récente
        </div>
        {% endif %}
    </div>

    <!-- Activité système -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-history"></i> Activité système
        </div>
        <div style="padding:var(--spacing-md);">
            {% for a in activites_recentes %}
            <div style="display:flex;gap:var(--spacing-sm);margin-bottom:var(--spacing-md);padding-bottom:var(--spacing-sm);border-bottom:1px solid var(--border-color);">
                <div style="width:32px;height:32px;background:var(--light-green);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i class="fas fa-{{ a.icone|default:'info-circle' }}" style="font-size:13px;color:var(--primary-green);"></i>
                </div>
                <div style="flex:1;min-width:0;">
                    <div style="font-size:12px;font-weight:500;color:var(--text-primary);margin-bottom:2px;">
                        {% if a.description %}{{ a.description|truncatechars:60 }}{% else %}{{ a.action }}{% endif %}
                    </div>
                    <div style="font-size:10px;color:var(--text-muted);">{{ a.cree_le|timesince }} ago</div>
                </div>
            </div>
            {% empty %}
            <div style="text-align:center;padding:var(--spacing-lg);color:var(--text-muted);font-size:13px;">
                <i class="fas fa-inbox" style="font-size:32px;display:block;margin-bottom:8px;opacity:.4;"></i>
                Aucune activité récente
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block dashboard_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
(function () {
    /* ── Palette commune ──────────────────────────────────────── */
    var GREEN    = '#28a745';
    var GREEN_BG = 'rgba(40,167,69,0.15)';
    var PURPLE   = '#6f42c1';
    var TEAL     = '#17a2b8';
    var YELLOW   = '#ffc107';
    var RED      = '#dc3545';

    Chart.defaults.font.family = "'Inter','Segoe UI',sans-serif";
    Chart.defaults.font.size   = 12;

    /* ── 1. Graphe barres : montants des transactions récentes ── */
    /* Données construites directement dans le template Django     */
    var txLabels  = [{% for t in transactions_recentes|slice:":8" %}'{{ t.numero_transaction|slice:"-8:" }}'{% if not forloop.last %},{% endif %}{% endfor %}];
    var txMontant = [{% for t in transactions_recentes|slice:":8" %}{{ t.montant_total|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];

    /* Inverser pour ordre chronologique (plus ancien → plus récent) */
    txLabels  = txLabels.reverse();
    txMontant = txMontant.reverse();

    if (txLabels.length === 0) {
        txLabels  = ['Aucune donnée'];
        txMontant = [0];
    }

    new Chart(document.getElementById('transactionsChart'), {
        type: 'bar',
        data: {
            labels: txLabels,
            datasets: [{
                label: 'Montant (FCFA)',
                data: txMontant,
                backgroundColor: GREEN_BG,
                borderColor: GREEN,
                borderWidth: 2,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(c) { return c.parsed.y.toLocaleString('fr-FR') + ' FCFA'; }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,.05)' },
                    ticks: {
                        callback: function(v) { return v >= 1000 ? (v/1000).toFixed(0) + 'k' : v; }
                    }
                },
                x: { grid: { display: false } }
            }
        }
    });

    /* ── 2. Donut : employés par direction ────────────────────── */
    var dirLabels = [{% for d in directions_principales %}'{{ d.nom|truncatechars:18 }}'{% if not forloop.last %},{% endif %}{% endfor %}];
    var dirData   = [{% for d in directions_principales %}{{ d.nombre_employes }}{% if not forloop.last %},{% endif %}{% endfor %}];

    if (dirLabels.length > 0) {
        new Chart(document.getElementById('directionsDonut'), {
            type: 'doughnut',
            data: {
                labels: dirLabels,
                datasets: [{
                    data: dirData,
                    backgroundColor: [GREEN, TEAL, PURPLE, YELLOW, RED],
                    borderWidth: 2,
                    borderColor: '#fff',
                }]
            },
            options: {
                responsive: true,
                cutout: '65%',
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
                    tooltip: {
                        callbacks: {
                            label: function(c) { return ' ' + c.label + ' : ' + c.parsed + ' employés'; }
                        }
                    }
                }
            }
        });
    }
})();
</script>
{% endblock %}