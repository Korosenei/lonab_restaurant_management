{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
.menu-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 8px rgba(0,0,0,.06);
    transition: transform .2s, box-shadow .2s;
}
.menu-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,.1);
}
.menu-img {
    width: 100%; height: 160px;
    object-fit: cover; background: var(--light-green);
    display: flex; align-items: center; justify-content: center;
}
.menu-body { padding: 16px; }
.menu-plat {
    font-size: 12px; color: var(--text-muted);
    background: var(--bg-light); padding: 4px 8px;
    border-radius: 20px; display: inline-block; margin: 2px 2px 2px 0;
}
.ticket-banner {
    background: linear-gradient(135deg,#1a5c2e,#28a745);
    border-radius: 12px; padding: 16px 20px;
    color: white; display: flex; align-items: center; gap: 16px;
    margin-bottom: 24px;
}
.res-item {
    display: flex; align-items: center; gap: 14px;
    padding: 12px; border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 8px;
}
</style>
{% endblock %}

{% block sidebar_menu %}{% include 'dashboards/sidebars/client_sidebar.html' %}{% endblock %}

{% block page_content %}
<div id="page-urls"
     data-reserver-url="{% url 'restaurants:client_reserver' %}"
     data-annuler-base="{% url 'restaurants:client_annuler' pk=0 %}"
     style="display:none;"></div>

<!-- En-tête + solde tickets -->
<div style="margin-bottom:20px;">
    <h1 style="font-size:22px;font-weight:700;color:var(--text-primary);margin:0 0 16px;">
        <i class="fas fa-book-open" style="color:var(--primary-green);margin-right:10px;"></i>
        Menus du {{ jour_fr|title }} — {{ aujourd_hui|date:"d F Y" }}
    </h1>

    <div class="ticket-banner">
        <div style="width:52px;height:52px;background:rgba(255,255,255,.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
            <i class="fas fa-ticket-alt"></i>
        </div>
        <div>
            <div style="font-size:24px;font-weight:800;">{{ tickets_valides }} ticket(s)</div>
            <div style="font-size:13px;opacity:.85;">disponibles ce mois</div>
        </div>
        <div style="margin-left:auto;">
            <a href="# url 'tickets:client_tickets' " style="color:white;font-size:13px;opacity:.9;text-decoration:none;">
                <i class="fas fa-arrow-right"></i> Voir mes tickets
            </a>
        </div>
    </div>
</div>

<div style="display:grid;grid-template-columns:1fr 340px;gap:20px;">

    <!-- Menus -->
    <div>
        {% if tickets_valides == 0 %}
        <div class="card" style="padding:32px;text-align:center;color:var(--text-muted);">
            <i class="fas fa-ticket-alt" style="font-size:40px;opacity:.3;margin-bottom:12px;display:block;"></i>
            <p style="font-weight:600;margin:0 0 8px;">Aucun ticket disponible</p>
            <p style="font-size:13px;margin:0;">Contactez votre caissier pour acheter des tickets.</p>
        </div>
        {% elif not menus_du_jour %}
        <div class="card" style="padding:32px;text-align:center;color:var(--text-muted);">
            <i class="fas fa-book-open" style="font-size:40px;opacity:.3;margin-bottom:12px;display:block;"></i>
            <p style="font-weight:600;margin:0 0 8px;">Aucun menu disponible aujourd'hui</p>
            {% if not restaurants_actifs %}
            <p style="font-size:13px;margin:0;">Aucun restaurant n'est planifié pour votre agence.</p>
            {% endif %}
        </div>
        {% else %}
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;">
            {% for menu in menus_du_jour %}
            <div class="menu-card">
                {% if menu.image %}
                <img src="{{ menu.image.url }}" alt="{{ menu.nom }}" class="menu-img">
                {% else %}
                <div class="menu-img">
                    <i class="fas fa-utensils" style="font-size:40px;color:var(--primary-green);opacity:.4;"></i>
                </div>
                {% endif %}
                <div class="menu-body">
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">
                        <i class="fas fa-store"></i> {{ menu.restaurant.nom }}
                    </div>
                    <h3 style="font-size:15px;font-weight:700;margin:0 0 8px;color:var(--text-primary);">{{ menu.nom }}</h3>
                    <div style="margin-bottom:10px;">
                        {% for plat in menu.plats|truncatechars:80 %}{% endfor %}
                        <span class="menu-plat">{{ menu.plats|truncatechars:60 }}</span>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;">
                        <span style="font-size:13px;color:var(--text-muted);">
                            {% if menu.quantite_restante is not None %}
                            <i class="fas fa-layer-group"></i>
                            <span style="color:{% if menu.quantite_restante < 5 %}#dc3545{% else %}var(--primary-green){% endif %};">
                                {{ menu.quantite_restante }}
                            </span> restants
                            {% endif %}
                        </span>
                        <button onclick="reserver({{ menu.id }}, '{{ menu.nom|escapejs }}')"
                                class="btn btn-primary" style="padding:7px 14px;font-size:13px;">
                            <i class="fas fa-bookmark"></i> Réserver
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Mes réservations du jour -->
    <div>
        <div class="card" style="padding:20px;">
            <h3 style="font-size:15px;font-weight:700;margin:0 0 16px;color:var(--text-primary);">
                <i class="fas fa-calendar-check" style="color:var(--primary-green);margin-right:8px;"></i>
                Mes réservations
            </h3>
            {% for res in mes_reservations %}
            <div class="res-item">
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:13px;">{{ res.menu.nom }}</div>
                    <div style="font-size:11px;color:var(--text-muted);">{{ res.restaurant.nom }}</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                    {% if res.statut == 'EN_ATTENTE' %}
                    <span class="badge badge-warning">En attente</span>
                    <button onclick="annuler({{ res.id }})" style="font-size:11px;color:#dc3545;background:none;border:none;cursor:pointer;">
                        Annuler
                    </button>
                    {% elif res.statut == 'CONFIRME' %}
                    <span class="badge badge-success">Confirmé</span>
                    {% elif res.statut == 'TERMINE' %}
                    <span class="badge badge-secondary">Terminé</span>
                    {% else %}
                    <span class="badge badge-danger">Annulé</span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div style="text-align:center;color:var(--text-muted);padding:20px;">
                <i class="fas fa-calendar" style="opacity:.3;font-size:28px;margin-bottom:8px;display:block;"></i>
                Aucune réservation aujourd'hui
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
var urls = document.getElementById('page-urls').dataset;

function reserver(menuId, menuNom) {
    if (!confirm('Réserver le menu « ' + menuNom + ' » pour aujourd\'hui ?')) return;
    var fd = new FormData();
    fd.append('menu_id', menuId);
    fetch(urls.reserverUrl, { method:'POST', headers:{'X-CSRFToken':getCsrfToken()}, body:fd })
        .then(r => r.json()).then(d => {
            if (d.success) { showToast(d.message, 'success'); setTimeout(() => location.reload(), 1000); }
            else showToast(d.error, 'error');
        });
}

function annuler(resId) {
    if (!confirm('Annuler cette réservation ?')) return;
    fetch(urls.annulerBase.replace('/0/', '/' + resId + '/'), {
        method:'POST', headers:{'X-CSRFToken':getCsrfToken()}
    }).then(r => r.json()).then(d => {
        if (d.success) { showToast(d.message, 'success'); setTimeout(() => location.reload(), 1000); }
        else showToast(d.error, 'error');
    });
}
</script>
{% endblock %}