{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Dashboard — {{ restaurant.nom }}{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
    .kpi {
        display: flex;
        align-items: center;
        gap: 12px;
        background: white;
        border-radius: 10px;
        padding: 14px 16px;
        box-shadow: 0 1px 4px rgba(0,0,0,.07);
    }
    .kpi-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 17px;
        flex-shrink: 0;
    }
    .kpi-val {
        font-size: 22px;
        font-weight: 800;
        line-height: 1;
    }
    .kpi-lbl {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
    }
    .res-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 9px 14px;
        border-bottom: 1px solid var(--border-color);
    }
    .res-row:last-child {
        border-bottom: none;
    }
    .res-row:hover {
        background: var(--bg-light);
    }
</style>
{% endblock %}

{% block sidebar_menu %}
    {% include 'dashboards/sidebars/restaurant_sidebar.html' %}
{% endblock %}

{% block page_content %}
<!-- Header -->
<div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:18px;">
    <div>
        <h1 style="font-size:20px; font-weight:700; color:var(--text-primary); margin:0;">
            <i class="fas fa-utensils" style="color:var(--primary-green); margin-right:8px;"></i>
            {{ restaurant.nom }}
        </h1>
        <p style="color:var(--text-muted); font-size:12px; margin:3px 0 0;">
            <i class="fas fa-map-marker-alt"></i>
            {{ restaurant.ville }} · {{ aujourd_hui|date:"l d F Y" }}
        </p>
    </div>
    <div style="display:flex; gap:7px;">
        <a href="{% url 'restaurants:gestionnaire_scanner' %}" class="btn btn-primary" style="font-size:13px; padding:8px 14px;">
            <i class="fas fa-qrcode"></i> Scanner
        </a>
        <a href="{% url 'restaurants:menus_list' %}" class="btn btn-outline" style="font-size:13px; padding:8px 14px;">
            <i class="fas fa-utensils"></i> Menus
        </a>
    </div>
</div>

<!-- KPI Cards — 6 compact -->
<div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:16px;">
    <div class="kpi" style="border-left:3px solid var(--primary-green);">
        <div class="kpi-icon" style="background:#e8f5e9;">
            <i class="fas fa-ticket-alt" style="color:var(--primary-green);"></i>
        </div>
        <div>
            <div class="kpi-val" style="color:var(--primary-green);">{{ tickets_aujourd_hui }}</div>
            <div class="kpi-lbl">Aujourd'hui</div>
        </div>
    </div>

    <div class="kpi" style="border-left:3px solid #f59e0b;">
        <div class="kpi-icon" style="background:#fff8e1;">
            <i class="fas fa-calendar-week" style="color:#f59e0b;"></i>
        </div>
        <div>
            <div class="kpi-val" style="color:#f59e0b;">{{ tickets_semaine }}</div>
            <div class="kpi-lbl">Cette semaine</div>
        </div>
    </div>

    <div class="kpi" style="border-left:3px solid #6f42c1;">
        <div class="kpi-icon" style="background:#f3e5f5;">
            <i class="fas fa-calendar-alt" style="color:#6f42c1;"></i>
        </div>
        <div>
            <div class="kpi-val" style="color:#6f42c1;">{{ tickets_ce_mois }}</div>
            <div class="kpi-lbl">Ce mois</div>
        </div>
    </div>

    <div class="kpi" style="border-left:3px solid #ffc107;">
        <div class="kpi-icon" style="background:#fff3cd;">
            <i class="fas fa-clock" style="color:#ffc107;"></i>
        </div>
        <div>
            <div class="kpi-val" style="color:#ffc107;">{{ nb_attente }}</div>
            <div class="kpi-lbl">En attente</div>
        </div>
    </div>

    <div class="kpi" style="border-left:3px solid #28a745;">
        <div class="kpi-icon" style="background:#e8f5e9;">
            <i class="fas fa-check-circle" style="color:#28a745;"></i>
        </div>
        <div>
            <div class="kpi-val" style="color:#28a745;">{{ nb_confirme }}</div>
            <div class="kpi-lbl">Confirmées</div>
        </div>
    </div>

    <div class="kpi" style="border-left:3px solid #6c757d;">
        <div class="kpi-icon" style="background:#f8f9fa;">
            <i class="fas fa-flag-checkered" style="color:#6c757d;"></i>
        </div>
        <div>
            <div class="kpi-val" style="color:#6c757d;">{{ nb_termine }}</div>
            <div class="kpi-lbl">Repas servis</div>
        </div>
    </div>
</div>

<!-- Graphe + Plats du jour -->
<div style="display:grid; grid-template-columns:2fr 1fr; gap:14px; margin-bottom:14px;">
    <!-- Graphique -->
    <div class="card" style="padding:16px;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <h3 style="font-size:13px; font-weight:700; margin:0;">
                <i class="fas fa-chart-bar" style="color:var(--primary-green); margin-right:6px;"></i>
                Tickets validés — 7 derniers jours
            </h3>
            <a href="{% url 'restaurants:gestionnaire_consommations' %}" style="font-size:11px; color:var(--primary-green);">
                Voir tout →
            </a>
        </div>
        <canvas id="barChart7j" height="100"></canvas>
    </div>

    <!-- Plats du jour -->
    <div class="card" style="overflow:hidden;">
        <div style="padding:11px 14px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; justify-content:space-between;">
            <span style="font-size:13px; font-weight:700;">
                <i class="fas fa-utensils" style="color:var(--primary-green); margin-right:6px;"></i>
                Plats du jour
            </span>
            <a href="{% url 'restaurants:menus_list' %}" style="font-size:11px; color:var(--primary-green);">
                Gérer →
            </a>
        </div>

        <div style="max-height:180px; overflow-y:auto;">
            {% for plat in menus_aujourd_hui %}
            <div style="display:flex; align-items:center; gap:8px; padding:8px 12px; border-bottom:1px solid var(--border-color);">
                <div style="width:28px; height:28px; border-radius:6px; background:var(--light-green); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                    <i class="fas fa-utensils" style="font-size:11px; color:var(--primary-green);"></i>
                </div>
                <div style="flex:1; min-width:0;">
                    <div style="font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        {{ plat.nom }}
                    </div>
                    {% if plat.quantite_disponible is not None %}
                    <div style="font-size:10px; color:{% if plat.quantite_disponible < 5 %}#dc3545{% else %}var(--text-muted){% endif %};">
                        {{ plat.quantite_disponible }} restants
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div style="text-align:center; padding:24px 12px; color:var(--text-muted); font-size:12px;">
                <i class="fas fa-exclamation-circle" style="display:block; font-size:22px; margin-bottom:6px; opacity:.3;"></i>
                Aucun plat configuré
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Réservations + Donut -->
<div style="display:grid; grid-template-columns:2fr 1fr; gap:14px;">
    <!-- Liste réservations -->
    <div class="card" style="overflow:hidden;">
        <div style="padding:11px 16px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; justify-content:space-between;">
            <span style="font-size:13px; font-weight:700;">
                <i class="fas fa-list" style="color:var(--primary-green); margin-right:6px;"></i>
                Réservations du jour
            </span>
            <div style="display:flex; gap:4px;">
                <span class="badge badge-warning" style="font-size:10px;">{{ nb_attente }}</span>
                <span class="badge badge-success" style="font-size:10px;">{{ nb_confirme }}</span>
                <span class="badge" style="font-size:10px; background:#6c757d; color:white;">{{ nb_termine }}</span>
            </div>
        </div>

        <div style="max-height:280px; overflow-y:auto;">
            {% for r in reservations_aujourd_hui %}
            <div class="res-row">
                <div style="width:30px; height:30px; border-radius:50%; background:var(--light-green); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:var(--primary-green); flex-shrink:0;">
                    {{ r.client.prenom.0 }}{{ r.client.nom.0 }}
                </div>
                <div style="flex:1; min-width:0;">
                    <div style="font-size:12px; font-weight:600; color:var(--text-primary);">
                        {{ r.client.get_full_name }}
                    </div>
                    <div style="font-size:11px; color:var(--text-muted);">
                        <i class="fas fa-utensils" style="font-size:9px;"></i>
                        <strong>{{ r.menu.nom }}</strong> · {{ r.client.matricule|default:"—" }}
                    </div>
                </div>
                <span class="badge {% if r.statut == 'EN_ATTENTE' %}badge-warning{% elif r.statut == 'CONFIRME' %}badge-success{% elif r.statut == 'TERMINE' %}badge-secondary{% else %}badge-danger{% endif %}" style="font-size:10px; flex-shrink:0;">
                    {{ r.get_statut_display }}
                </span>
            </div>
            {% empty %}
            <div style="text-align:center; padding:32px; color:var(--text-muted);">
                <i class="fas fa-calendar-times" style="font-size:28px; display:block; margin-bottom:10px; opacity:.25;"></i>
                Aucune réservation aujourd'hui
            </div>
            {% endfor %}
        </div>

        {% if reservations_aujourd_hui %}
        <div style="padding:9px 14px; border-top:1px solid var(--border-color); text-align:right;">
            <a href="{% url 'restaurants:gestionnaire_reservations' %}" style="font-size:11px; color:var(--primary-green);">
                Toutes les réservations →
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Donut + Infos restaurant -->
    <div style="display:flex; flex-direction:column; gap:12px;">
        <div class="card" style="padding:14px;">
            <div style="font-size:12px; font-weight:700; margin-bottom:10px;">
                <i class="fas fa-chart-pie" style="color:var(--primary-green); margin-right:5px;"></i>
                Réservations
            </div>
            <canvas id="donutReservations" height="130"></canvas>
        </div>

        <div class="card" style="padding:14px;">
            <div style="font-size:12px; font-weight:700; margin-bottom:8px;">
                <i class="fas fa-store" style="color:var(--primary-green); margin-right:5px;"></i>
                Restaurant
            </div>
            <div style="font-size:11px; color:var(--text-muted); line-height:2;">
                {% if restaurant.telephone %}
                <div>
                    <i class="fas fa-phone" style="color:var(--primary-green); width:14px;"></i>
                    {{ restaurant.telephone }}
                </div>
                {% endif %}
                {% if restaurant.adresse %}
                <div>
                    <i class="fas fa-map-marker-alt" style="color:var(--primary-green); width:14px;"></i>
                    {{ restaurant.adresse }}
                </div>
                {% endif %}
                <div style="margin-top:6px;">
                    <span class="badge {% if restaurant.statut == 'ACTIF' %}badge-success{% else %}badge-warning{% endif %}" style="font-size:10px;">
                        {{ restaurant.get_statut_display }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="graphData7j" type="application/json">
    [{% for d in graph_7j %}
        {"label":"{{ d.label }}","value":{{ d.value }}}{% if not forloop.last %},{% endif %}
    {% endfor %}]
</script>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
    (function() {
        Chart.defaults.font.family = "'Inter','Segoe UI',sans-serif";
        Chart.defaults.font.size = 11;

        var raw = JSON.parse(document.getElementById('graphData7j').textContent);

        new Chart(document.getElementById('barChart7j'), {
            type: 'bar',
            data: {
                labels: raw.map(function(d) { return d.label; }),
                datasets: [{
                    label: 'Tickets',
                    data: raw.map(function(d) { return d.value; }),
                    backgroundColor: 'rgba(40,167,69,.18)',
                    borderColor: '#28a745',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1, precision: 0 },
                        grid: { color: 'rgba(0,0,0,.04)' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        var a = {{ nb_attente|default:0 }},
            b = {{ nb_confirme|default:0 }},
            c = {{ nb_termine|default:0 }},
            tot = a + b + c;

        new Chart(document.getElementById('donutReservations'), {
            type: 'doughnut',
            data: {
                labels: ['Attente', 'Confirmées', 'Servies'],
                datasets: [{
                    data: tot > 0 ? [a, b, c] : [1, 1, 1],
                    backgroundColor: tot > 0 ? ['#ffc107', '#28a745', '#6c757d'] : ['#e9ecef', '#e9ecef', '#e9ecef'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 9,
                            padding: 8,
                            font: { size: 10 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(c) {
                                return tot > 0 ? ' ' + c.label + ' : ' + c.parsed : ' Aucune';
                            }
                        }
                    }
                }
            }
        });
    })();
</script>
{% endblock %}