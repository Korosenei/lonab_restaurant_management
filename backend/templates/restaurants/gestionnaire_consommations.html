{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Consommations — {{ restaurant.nom }}{% endblock %}
{% block dashboard_css %}<link rel="stylesheet" href="{% static 'css/components.css' %}">{% endblock %}
{% block sidebar_menu %}{% include 'dashboards/sidebars/restaurant_sidebar.html' %}{% endblock %}

{% block page_content %}
<!-- En-tête -->
<div class="page-header-with-actions">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-check-circle" style="color:var(--primary-green);margin-right:8px;"></i>Consommations
        </h1>
        <p class="page-subtitle">{{ restaurant.nom }} · Plats consommés et validations</p>
    </div>
    <div class="page-header-actions">
        <a href="{% url 'restaurants:gestionnaire_scanner' %}" class="btn btn-primary">
            <i class="fas fa-qrcode"></i> Scanner
        </a>
    </div>
</div>

<!-- ═══ Stats Pills ════════════════════════════════════════════ -->
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;">
    <div style="display:flex;align-items:center;gap:8px;background:white;border-radius:20px;
                padding:8px 16px;box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:4px solid var(--primary-green);">
        <i class="fas fa-ticket-alt" style="color:var(--primary-green);"></i>
        <span style="font-weight:700;font-size:16px;">{{ stats.aujourd_hui }}</span>
        <span style="font-size:12px;color:var(--text-muted);">aujourd'hui</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;background:white;border-radius:20px;
                padding:8px 16px;box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:4px solid #17a2b8;">
        <i class="fas fa-calendar-week" style="color:#17a2b8;"></i>
        <span style="font-weight:700;font-size:16px;">{{ stats.cette_semaine }}</span>
        <span style="font-size:12px;color:var(--text-muted);">7 derniers jours</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;background:white;border-radius:20px;
                padding:8px 16px;box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:4px solid #6f42c1;">
        <i class="fas fa-calendar-alt" style="color:#6f42c1;"></i>
        <span style="font-weight:700;font-size:16px;">{{ stats.ce_mois }}</span>
        <span style="font-size:12px;color:var(--text-muted);">ce mois ({{ debut_mois|date:"M Y" }})</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;background:white;border-radius:20px;
                padding:8px 16px;box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:4px solid #ffc107;">
        <i class="fas fa-filter" style="color:#ffc107;"></i>
        <span style="font-weight:700;font-size:16px;">{{ stats.total_filtre }}</span>
        <span style="font-size:12px;color:var(--text-muted);">filtrés</span>
    </div>
</div>

<!-- ═══ Graphe 7 jours + Filtres ═══════════════════════════════ -->
<div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:18px;">

    <!-- Graphe barres 7 derniers jours -->
    <div class="card" style="padding:18px 20px;">
        <div style="font-size:14px;font-weight:600;margin-bottom:12px;color:var(--text-primary);">
            <i class="fas fa-chart-bar" style="color:var(--primary-green);margin-right:6px;"></i>
            Activité — 7 derniers jours
        </div>
        <canvas id="graphJours" height="90"></canvas>
    </div>

    <!-- Filtres -->
    <div class="card" style="padding:18px 20px;">
        <div style="font-size:14px;font-weight:600;margin-bottom:12px;color:var(--text-primary);">
            <i class="fas fa-search" style="color:var(--primary-green);margin-right:6px;"></i>Filtres
        </div>
        <form method="get" style="display:flex;flex-direction:column;gap:10px;">
            <input type="text" name="search" class="form-control" placeholder="Employé / matricule / ticket"
                   value="{{ filtres.search }}" style="font-size:13px;">
            <select name="agence" class="form-control" style="font-size:13px;">
                <option value="">Toutes les agences</option>
                {% for a in agences %}
                <option value="{{ a.id }}" {% if filtres.agence == a.id|stringformat:'s' %}selected{% endif %}>{{ a.nom }}</option>
                {% endfor %}
            </select>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div>
                    <label style="font-size:10px;color:var(--text-muted);">Du</label>
                    <input type="date" name="date_debut" class="form-control" value="{{ filtres.date_debut }}" style="font-size:12px;">
                </div>
                <div>
                    <label style="font-size:10px;color:var(--text-muted);">Au</label>
                    <input type="date" name="date_fin" class="form-control" value="{{ filtres.date_fin }}" style="font-size:12px;">
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="font-size:13px;">
                <i class="fas fa-search"></i> Filtrer
            </button>
            {% if filtres.search or filtres.agence or filtres.date_debut or filtres.date_fin %}
            <a href="{% url 'restaurants:gestionnaire_consommations' %}"
               class="btn btn-outline" style="font-size:12px;text-align:center;">
                <i class="fas fa-times"></i> Réinitialiser
            </a>
            {% endif %}
        </form>
    </div>
</div>

<!-- ═══ Tableau consommations ═══════════════════════════════════ -->
<div class="data-table-wrapper">
    <div class="data-table-body">
        <div class="table-responsive">
            <table class="table" id="consoTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>N° Ticket</th>
                        <th>Employé</th>
                        <th>Matricule</th>
                        <th>Agence</th>
                        <th>Date & Heure</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tickets %}
                    <tr>
                        <td style="color:var(--text-muted);font-size:12px;">{{ forloop.counter }}</td>
                        <td>
                            <span style="font-family:monospace;font-size:12px;font-weight:700;color:var(--primary-green);">
                                {{ t.numero_ticket }}
                            </span>
                        </td>
                        <td>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div style="width:28px;height:28px;border-radius:50%;background:var(--light-green);
                                            display:flex;align-items:center;justify-content:center;
                                            font-size:11px;font-weight:700;color:var(--primary-green);flex-shrink:0;overflow:hidden;">
                                    {% if t.proprietaire.photo_profil %}
                                    <img src="{{ t.proprietaire.photo_profil.url }}" style="width:100%;height:100%;object-fit:cover;">
                                    {% else %}
                                    {{ t.proprietaire.prenom.0 }}{{ t.proprietaire.nom.0 }}
                                    {% endif %}
                                </div>
                                <span style="font-size:13px;font-weight:600;">{{ t.proprietaire.get_full_name }}</span>
                            </div>
                        </td>
                        <td style="font-size:12px;font-family:monospace;color:var(--text-muted);">
                            {{ t.proprietaire.matricule|default:"—" }}
                        </td>
                        <td style="font-size:12px;">{{ t.proprietaire.agence.nom|default:"—" }}</td>
                        <td style="font-size:12px;color:var(--text-muted);">
                            {{ t.date_consommation|date:"d/m/Y" }}
                            <span style="font-weight:600;color:var(--text-primary);">{{ t.date_consommation|date:"H:i" }}</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fas fa-check-circle"></i>
                                <p>Aucune consommation enregistrée</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Données graphe -->
<script id="graphData" type="application/json">
[{% for d in graph_data %}{"label":"{{ d.label }}","value":{{ d.value }}}{% if not forloop.last %},{% endif %}{% endfor %}]
</script>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
(function() {
    Chart.defaults.font.family = "'Inter','Segoe UI',sans-serif";
    var raw = JSON.parse(document.getElementById('graphData').textContent);
    new Chart(document.getElementById('graphJours'), {
        type: 'bar',
        data: {
            labels: raw.map(function(d){return d.label;}),
            datasets: [{
                label: 'Tickets validés',
                data: raw.map(function(d){return d.value;}),
                backgroundColor: 'rgba(40,167,69,.2)',
                borderColor: '#28a745',
                borderWidth: 2,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,.05)' },
                     ticks: { stepSize: 1 } },
                x: { grid: { display: false } }
            }
        }
    });
})();
</script>
{% endblock %}