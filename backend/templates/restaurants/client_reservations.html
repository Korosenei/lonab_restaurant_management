{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Mes réservations{% endblock %}
{% block dashboard_css %}<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
.res-row{display:flex;align-items:center;gap:12px;padding:11px 16px;border-bottom:1px solid var(--border-color);}
.res-row:last-child{border-bottom:none;}
.res-row:hover{background:var(--bg-light);}
</style>
{% endblock %}

{% block sidebar_menu %}{% include 'dashboards/sidebars/client_sidebar.html' %}{% endblock %}

{% block page_content %}
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:18px;">
    <div>
        <h1 style="font-size:20px;font-weight:700;margin:0;color:var(--text-primary);">
            <i class="fas fa-calendar-check" style="color:var(--primary-green);margin-right:8px;"></i>Mes réservations
        </h1>
        <p style="color:var(--text-muted);font-size:12px;margin:3px 0 0;">Toutes vos réservations de plats</p>
    </div>
    <a href="{% url 'restaurants:client_menus' %}" class="btn btn-primary" style="font-size:13px;padding:8px 14px;">
        <i class="fas fa-book-open"></i> Menus du jour
    </a>
</div>

<!-- Filtres statut -->
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;">
    <a href="{% url 'restaurants:client_reservations' %}"
       style="padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;text-decoration:none;
              {% if not filtre_actif %}background:var(--primary-green);color:white;{% else %}background:var(--bg-secondary);color:var(--text-muted);{% endif %}">
        Toutes
    </a>
    {% for val, label in statuts %}
    <a href="?statut={{ val }}"
       style="padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;text-decoration:none;
              {% if filtre_actif == val %}background:var(--primary-green);color:white;{% else %}background:var(--bg-secondary);color:var(--text-muted);{% endif %}">
        {{ label }}
    </a>
    {% endfor %}
</div>

<!-- Liste -->
<div class="card" style="overflow:hidden;">
    {% if reservations %}
    {% for r in reservations %}
    <div class="res-row">
        <!-- Icône statut -->
        <div style="width:36px;height:36px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;
            {% if r.statut == 'EN_ATTENTE' %}background:#fff3cd;{% elif r.statut == 'CONFIRME' %}background:var(--light-green);{% elif r.statut == 'TERMINE' %}background:#e3f2fd;{% else %}background:#f8f9fa;{% endif %}">
            <i class="fas fa-{% if r.statut == 'EN_ATTENTE' %}clock{% elif r.statut == 'CONFIRME' %}check{% elif r.statut == 'TERMINE' %}flag-checkered{% else %}times{% endif %}"
               style="font-size:14px;{% if r.statut == 'EN_ATTENTE' %}color:#ffc107;{% elif r.statut == 'CONFIRME' %}color:var(--primary-green);{% elif r.statut == 'TERMINE' %}color:#17a2b8;{% else %}color:#adb5bd;{% endif %}"></i>
        </div>

        <!-- Infos -->
        <div style="flex:1;min-width:0;">
            <div style="font-size:13px;font-weight:700;color:var(--text-primary);">
                <i class="fas fa-utensils" style="color:var(--primary-green);font-size:10px;margin-right:4px;"></i>
                {{ r.menu.nom }}
            </div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;line-height:1.5;">
                <i class="fas fa-store" style="width:12px;"></i> {{ r.restaurant.nom }}
                · <i class="fas fa-calendar" style="width:12px;"></i> {{ r.date_reservation|date:"d/m/Y" }}
            </div>
        </div>

        <!-- Statut + action -->
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0;">
            <span class="badge {% if r.statut == 'EN_ATTENTE' %}badge-warning{% elif r.statut == 'CONFIRME' %}badge-success{% elif r.statut == 'TERMINE' %}badge-info{% else %}badge-secondary{% endif %}" style="font-size:10px;">
                {{ r.get_statut_display }}
            </span>
            {% if r.statut not in 'TERMINE,ANNULE' %}
            <button onclick="annuler({{ r.id }}, this)"
                    style="background:none;border:none;color:#dc3545;font-size:11px;cursor:pointer;padding:0;font-weight:600;">
                <i class="fas fa-times"></i> Annuler
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div style="text-align:center;padding:40px;color:var(--text-muted);">
        <i class="fas fa-calendar-times" style="font-size:36px;display:block;margin-bottom:12px;opacity:.2;"></i>
        Aucune réservation{% if filtre_actif %} avec ce statut{% endif %}
        {% if not filtre_actif %}
        <br><a href="{% url 'restaurants:client_menus' %}" style="color:var(--primary-green);font-size:13px;font-weight:600;display:inline-block;margin-top:10px;">
            <i class="fas fa-book-open"></i> Voir les menus du jour →
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<div id="page-urls" data-annuler-base="{% url 'restaurants:client_annuler' pk=0 %}" style="display:none;"></div>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
function annuler(id, btn) {
    if (!confirm('Annuler cette réservation ?')) return;
    var url = document.getElementById('page-urls').dataset.annulerBase.replace('/0/', '/' + id + '/');
    btn.disabled = true;
    fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCsrfToken() } })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.success) { showSuccess(d.message); setTimeout(function(){ location.reload(); }, 600); }
        else { showError(d.error || 'Erreur'); btn.disabled = false; }
    })
    .catch(function() { showError('Erreur réseau'); btn.disabled = false; });
}
</script>
{% endblock %}