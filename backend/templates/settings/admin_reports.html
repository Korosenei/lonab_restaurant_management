{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Rapports — Administration{% endblock %}
{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
    .dc{background:#fff;border-radius:7px;box-shadow:0 1px 3px rgba(0,0,0,.07);overflow:hidden;margin-bottom:8px;}
    .dc-head{padding:8px 12px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;color:#374151;}
    .dc-head i{color:#28a745;font-size:10px;}
    .dc-body{padding:10px 12px;}
    .filter-row{display:flex;gap:7px;align-items:center;flex-wrap:wrap;}
    .filter-row select,.filter-row input[type=date],.filter-row input[type=text]{padding:5px 8px;border:1px solid #e5e7eb;border-radius:5px;font-size:11px;color:#374151;outline:none;}
    .filter-row select:focus,.filter-row input:focus{border-color:#28a745;}
    .btn-xs{padding:5px 10px;font-size:10px;border-radius:4px;border:none;cursor:pointer;font-weight:600;}
    .btn-g{background:#28a745;color:#fff;} .btn-o{background:#fff;border:1px solid #e5e7eb;color:#374151;}
    .exp-btns{display:flex;gap:5px;margin-left:auto;}
    .exp{padding:3px 8px;font-size:9px;border-radius:4px;border:1px solid;cursor:pointer;font-weight:700;}
    .exp.pdf{border-color:#dc3545;color:#dc3545;background:#fff;} .exp.pdf:hover{background:#dc3545;color:#fff;}
    .exp.xls{border-color:#28a745;color:#28a745;background:#fff;} .exp.xls:hover{background:#28a745;color:#fff;}
    .exp.csv{border-color:#17a2b8;color:#17a2b8;background:#fff;} .exp.csv:hover{background:#17a2b8;color:#fff;}
    .rp-btn{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:1px solid #e5e7eb;background:#f9fafb;cursor:pointer;margin-bottom:5px;transition:all .15s;text-decoration:none;}
    .rp-btn:hover{background:#f0faf4;border-color:#28a745;}
    .rp-icon{width:28px;height:28px;border-radius:5px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
    .rp-icon i{font-size:12px;}
    .rp-t{font-size:11px;font-weight:600;color:#111827;}
    .rp-s{font-size:9px;color:#9ca3af;margin-top:1px;}
    .rp-arrow{margin-left:auto;font-size:10px;color:#9ca3af;}
    .mt{width:100%;border-collapse:collapse;}
    .mt th{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#9ca3af;padding:6px 8px;border-bottom:1px solid #f3f4f6;text-align:left;}
    .mt td{font-size:10px;padding:6px 8px;border-bottom:1px solid #fafafa;color:#374151;}
    .mt tr:last-child td{border-bottom:none;}
    .mt tr:hover td{background:#fafafa;}
</style>{% endblock %}

{% block sidebar_menu %}{% include 'dashboards/sidebars/admin_sidebar.html' %}{% endblock %}

{% block page_content %}
<div class="page-header" style="margin-bottom:12px;">
    <h1 class="page-title" style="font-size:17px;">Rapports</h1>
    <p class="page-subtitle" style="font-size:11px;">Générez et exportez vos rapports</p>
</div>

<!-- Filtres -->
<div class="dc">
    <div class="dc-head"><i class="fas fa-filter"></i> Filtres période</div>
    <div class="dc-body">
        <form method="get" class="filter-row">
            <label style="font-size:10px;color:#6b7280;">Du</label>
            <input type="date" name="date_debut" value="{{ filtres.date_debut|default:'' }}">
            <label style="font-size:10px;color:#6b7280;">Au</label>
            <input type="date" name="date_fin" value="{{ filtres.date_fin|default:'' }}">
           <select name="agence">
    <option value="">Toutes les agences</option>
    {% for a in agences %}
        <option value="{{ a.id }}"
            {% if filtres.agence == a.id|stringformat:"s" %}selected{% endif %}>
            {{ a.nom }}
        </option>
    {% endfor %}
</select>
            <select name="type">
                <option value="">Tous types</option>
                <option value="tickets">Tickets</option>
                <option value="transactions">Transactions</option>
                <option value="consommations">Consommations</option>
            </select>
            <button type="submit" class="btn-xs btn-g">Appliquer</button>
            <a href="{% url 'settings:admin_reports' %}" class="btn-xs btn-o" style="text-decoration:none;">Reset</a>
            <div class="exp-btns">
                <button type="button" class="exp pdf" onclick="window.print()"><i class="fas fa-file-pdf"></i> PDF
                </button>
                <button type="button" class="exp xls"><i class="fas fa-file-excel"></i> Excel</button>
                <button type="button" class="exp csv"><i class="fas fa-file-csv"></i> CSV</button>
            </div>
        </form>
    </div>
</div>

<div style="display:grid;grid-template-columns:1fr 2fr;gap:8px;">
    <!-- Rapports rapides -->
    <div class="dc" style="margin-bottom:0;">
        <div class="dc-head"><i class="fas fa-list"></i> Rapports disponibles</div>
        <div class="dc-body">
            <a href="#" class="rp-btn">
                <div class="rp-icon" style="background:#d1fae5;"><i class="fas fa-ticket-alt"
                                                                    style="color:#28a745;"></i></div>
                <div>
                    <div class="rp-t">Tickets vendus</div>
                    <div class="rp-s">Par agence · par mois</div>
                </div>
                <span class="rp-arrow">→</span>
            </a>
            <a href="#" class="rp-btn">
                <div class="rp-icon" style="background:#dbeafe;"><i class="fas fa-exchange-alt"
                                                                    style="color:#3b82f6;"></i></div>
                <div>
                    <div class="rp-t">Transactions</div>
                    <div class="rp-s">Historique complet</div>
                </div>
                <span class="rp-arrow">→</span>
            </a>
            <a href="#" class="rp-btn">
                <div class="rp-icon" style="background:#fef3c7;"><i class="fas fa-utensils" style="color:#e0a800;"></i>
                </div>
                <div>
                    <div class="rp-t">Consommations</div>
                    <div class="rp-s">Par restaurant · par date</div>
                </div>
                <span class="rp-arrow">→</span>
            </a>
            <a href="#" class="rp-btn">
                <div class="rp-icon" style="background:#ede7ff;"><i class="fas fa-users" style="color:#6f42c1;"></i>
                </div>
                <div>
                    <div class="rp-t">Employés</div>
                    <div class="rp-s">Par direction et agence</div>
                </div>
                <span class="rp-arrow">→</span>
            </a>
            <a href="#" class="rp-btn">
                <div class="rp-icon" style="background:#fee2e2;"><i class="fas fa-coins" style="color:#dc3545;"></i>
                </div>
                <div>
                    <div class="rp-t">Revenus &amp; Subventions</div>
                    <div class="rp-s">Récapitulatif financier</div>
                </div>
                <span class="rp-arrow">→</span>
            </a>
        </div>
    </div>

    <!-- Graphe mensuel -->
    <div class="dc" style="margin-bottom:0;">
        <div class="dc-head"><i class="fas fa-chart-line"></i> Évolution mensuelle — Tickets</div>
        <div class="dc-body" style="padding:8px 12px;">
            <canvas id="rptChart" height="140"></canvas>
        </div>
    </div>
</div>

<!-- Récap par agence -->
<div class="dc" style="margin-top:8px;">
    <div class="dc-head">
        <i class="fas fa-table"></i> Récapitulatif par agence
        <div class="exp-btns">
            <button class="exp pdf"><i class="fas fa-file-pdf"></i> PDF</button>
            <button class="exp xls"><i class="fas fa-file-excel"></i> Excel</button>
        </div>
    </div>
    <div style="overflow-x:auto;">
        <table class="mt">
            <thead>
            <tr>
                <th>Agence</th>
                <th style="text-align:center;">Employés</th>
                <th style="text-align:center;">Tickets achetés</th>
                <th style="text-align:center;">Tickets consommés</th>
                <th style="text-align:right;">Montant total</th>
                <th style="text-align:right;">Subvention</th>
            </tr>
            </thead>
            <tbody>
            {% for a in rapport_agences %}
            <tr>
                <td style="font-weight:600;color:#111827;">{{ a.nom }}</td>
                <td style="text-align:center;">{{ a.nb_employes|default:0 }}</td>
                <td style="text-align:center;">{{ a.tickets_achetes|default:0 }}</td>
                <td style="text-align:center;">{{ a.tickets_consommes|default:0 }}</td>
                <td style="text-align:right;font-weight:600;">{{ a.montant_total|default:0|floatformat:0 }} F</td>
                <td style="text-align:right;color:#28a745;font-weight:600;">{{ a.subvention|default:0|floatformat:0 }}
                    F
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="padding:18px;text-align:center;color:#9ca3af;font-size:10px;">Aucune donnée
                    disponible
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
    var mois=['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'];
    var dT=[{% for v in graph_mensuel_tickets %}{{ v }}{% if not forloop.last %},{% endif %}{% endfor %}];
    var dM=[{% for v in graph_mensuel_montants %}{{ v }}{% if not forloop.last %},{% endif %}{% endfor %}];
    if(!dT.length){dT=Array(12).fill(0);}
    if(!dM.length){dM=Array(12).fill(0);}
    Chart.defaults.font.size=9;
    new Chart(document.getElementById('rptChart'),{
        type:'line',
        data:{labels:mois,datasets:[
            {label:'Tickets vendus',data:dT,borderColor:'#28a745',backgroundColor:'rgba(40,167,69,.08)',tension:.3,fill:true,pointRadius:3,borderWidth:1.5},
            {label:'Montants (kFCFA)',data:dM.map(v=>+(v/1000).toFixed(1)),borderColor:'#17a2b8',backgroundColor:'rgba(23,162,184,.06)',tension:.3,fill:false,pointRadius:3,borderWidth:1.5}
        ]},
        options:{responsive:true,plugins:{legend:{position:'bottom',labels:{boxWidth:10,padding:8,font:{size:9}}}},
            scales:{y:{beginAtZero:true,grid:{color:'rgba(0,0,0,.04)'},ticks:{font:{size:9}}},x:{grid:{display:false},ticks:{font:{size:9}}}}}
    });
</script>
{% endblock %}