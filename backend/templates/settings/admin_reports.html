{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Rapports — Administration{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
.dc{background:#fff;border-radius:7px;box-shadow:0 1px 3px rgba(0,0,0,.07);overflow:hidden;margin-bottom:10px;}
.dc-head{padding:9px 14px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;color:#374151;}
.dc-head i{color:#28a745;font-size:10px;}
.dc-body{padding:10px 14px;}
.filter-row{display:flex;gap:7px;align-items:center;flex-wrap:wrap;}
.filter-row select,.filter-row input{padding:5px 8px;border:1px solid #e5e7eb;border-radius:5px;font-size:11px;color:#374151;outline:none;}
.filter-row select:focus,.filter-row input:focus{border-color:#28a745;}
.btn-xs{padding:5px 11px;font-size:11px;border-radius:4px;border:none;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:4px;}
.btn-g{background:#28a745;color:#fff;} .btn-g:hover{background:#218838;}
.btn-o{background:#fff;border:1px solid #e5e7eb;color:#374151;text-decoration:none;} .btn-o:hover{background:#f9fafb;}
/* Export buttons */
.exp-btns{display:flex;gap:5px;margin-left:auto;}
.exp{padding:4px 9px;font-size:10px;border-radius:4px;border:1px solid;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:4px;background:#fff;text-decoration:none;}
.exp.pdf{border-color:#dc3545;color:#dc3545;} .exp.pdf:hover{background:#dc3545;color:#fff;}
.exp.xls{border-color:#28a745;color:#28a745;} .exp.xls:hover{background:#28a745;color:#fff;}
.exp.csv{border-color:#17a2b8;color:#17a2b8;} .exp.csv:hover{background:#17a2b8;color:#fff;}
/* KPI strip */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:10px;}
.kpi{background:#fff;border-radius:7px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px 12px;border-left:3px solid #28a745;}
.kpi-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#9ca3af;margin-bottom:3px;}
.kpi-val{font-size:20px;font-weight:800;color:#111827;line-height:1.1;}
.kpi-sub{font-size:9px;color:#9ca3af;margin-top:2px;}
.kpi.blue{border-color:#17a2b8;} .kpi.yellow{border-color:#ffc107;} .kpi.purple{border-color:#6f42c1;} .kpi.red{border-color:#dc3545;}
/* Report links */
.rp-btn{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:1px solid #e5e7eb;background:#f9fafb;cursor:pointer;margin-bottom:5px;transition:all .15s;text-decoration:none;}
.rp-btn:hover{background:#f0faf4;border-color:#28a745;}
.rp-btn:last-child{margin-bottom:0;}
.rp-icon{width:30px;height:30px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.rp-icon i{font-size:12px;}
.rp-t{font-size:11px;font-weight:600;color:#111827;}
.rp-s{font-size:9px;color:#9ca3af;margin-top:1px;}
.rp-arrow{margin-left:auto;font-size:11px;color:#9ca3af;}
/* Table */
.mt{width:100%;border-collapse:collapse;}
.mt th{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#9ca3af;padding:8px 10px;border-bottom:2px solid #f3f4f6;text-align:left;background:#fafafa;}
.mt td{font-size:11px;padding:7px 10px;border-bottom:1px solid #fafafa;color:#374151;}
.mt tr:last-child td{border-bottom:none;} .mt tr:hover td{background:#fafafa;}
.mt tfoot td{background:#f8f9fa;font-weight:700;font-size:11px;border-top:2px solid #e5e7eb;}
/* Top restaurants */
.top-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #f9fafb;}
.top-item:last-child{border-bottom:none;}
.top-rank{width:20px;height:20px;border-radius:50%;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#6b7280;flex-shrink:0;}
.top-rank.gold{background:#fef3c7;color:#92400e;}
.top-bar{flex:1;background:#f3f4f6;border-radius:3px;height:5px;overflow:hidden;}
.top-bar-fill{height:100%;background:#28a745;border-radius:3px;}
@media(max-width:900px){.kpi-row{grid-template-columns:repeat(2,1fr);} .grid-2{grid-template-columns:1fr !important;}}
</style>
{% endblock %}

{% block sidebar_menu %}{% include 'dashboards/sidebars/admin_sidebar.html' %}{% endblock %}

{% block page_content %}

{# ── En-tête ── #}
<div class="page-header-with-actions">
    <div class="page-header">
        <h1 class="page-title"><i class="fas fa-chart-bar" style="color:var(--primary-green);margin-right:8px;"></i>Rapports</h1>
        <p class="page-subtitle">Analyses et statistiques — {{ filtres.date_debut }} → {{ filtres.date_fin }}</p>
    </div>
    <div class="page-header-actions">
        <button class="export-btn export-btn-pdf" onclick="window.print()"><i class="fas fa-file-pdf"></i> PDF</button>
    </div>
</div>

{# ── KPIs globaux période ── #}
<div class="kpi-row">
    <div class="kpi">
        <div class="kpi-label">Tickets achetés</div>
        <div class="kpi-val">{{ totaux.tickets|default:0 }}</div>
        <div class="kpi-sub">sur la période</div>
    </div>
    <div class="kpi blue">
        <div class="kpi-label">Tickets consommés</div>
        <div class="kpi-val">{{ totaux.consommes|default:0 }}</div>
        <div class="kpi-sub">
            {% if totaux.tickets > 0 %}{{ totaux.consommes|floatformat:0 }}/{{ totaux.tickets }} ({{ totaux.consommes|default:0|floatformat:0 }}{% with pct=totaux.consommes|default:0 %}{% endwith %}){% endif %}
        </div>
    </div>
    <div class="kpi yellow">
        <div class="kpi-label">Montant total</div>
        <div class="kpi-val" style="font-size:14px;">{{ totaux.montant|default:0|floatformat:0 }}</div>
        <div class="kpi-sub">FCFA encaissés</div>
    </div>
    <div class="kpi" style="border-color:#28a745;">
        <div class="kpi-label">Subvention totale</div>
        <div class="kpi-val" style="font-size:14px;color:#28a745;">{{ totaux.subvention|default:0|floatformat:0 }}</div>
        <div class="kpi-sub">FCFA MUTRALO</div>
    </div>
    <div class="kpi purple">
        <div class="kpi-label">Employés actifs</div>
        <div class="kpi-val">{{ totaux.employes|default:0 }}</div>
        <div class="kpi-sub">sur {{ rapport_agences|length }} agence{{ rapport_agences|length|pluralize }}</div>
    </div>
</div>

{# ── Filtres ── #}
<div class="dc">
    <div class="dc-head"><i class="fas fa-filter"></i> Filtres période</div>
    <div class="dc-body">
        <form method="get" class="filter-row">
            <label style="font-size:10px;color:#6b7280;">Du</label>
            <input type="date" name="date_debut" value="{{ filtres.date_debut|default:'' }}">
            <label style="font-size:10px;color:#6b7280;">Au</label>
            <input type="date" name="date_fin" value="{{ filtres.date_fin|default:'' }}">
            <select name="agence">
                <option value="">Toutes les agences</option>
                {% for a in agences %}
                <option value="{{ a.id }}" {% if filtres.agence == a.id|stringformat:"s" %}selected{% endif %}>{{ a.nom }}</option>
                {% endfor %}
            </select>
            <select name="type">
                <option value="">Tous types</option>
                <option value="tickets"        {% if filtres.type == 'tickets' %}selected{% endif %}>Tickets</option>
                <option value="transactions"   {% if filtres.type == 'transactions' %}selected{% endif %}>Transactions</option>
                <option value="consommations"  {% if filtres.type == 'consommations' %}selected{% endif %}>Consommations</option>
            </select>
            <button type="submit" class="btn-xs btn-g"><i class="fas fa-check"></i> Appliquer</button>
            <a href="{% url 'settings:admin_reports' %}" class="btn-xs btn-o"><i class="fas fa-times"></i> Reset</a>
        </form>
    </div>
</div>

{# ── Graphe + Top restaurants ── #}
<div style="display:grid;grid-template-columns:2fr 1fr;gap:10px;" class="grid-2">

    <div class="dc" style="margin-bottom:0;">
        <div class="dc-head"><i class="fas fa-chart-line"></i> Évolution mensuelle (12 mois glissants)</div>
        <div class="dc-body" style="padding:10px 14px;">
            <canvas id="rptChart" height="150"></canvas>
        </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:10px;">
        {# Top restaurants #}
        <div class="dc" style="margin-bottom:0;flex:1;">
            <div class="dc-head"><i class="fas fa-trophy"></i> Top restaurants — consommations</div>
            <div class="dc-body">
                {% if top_restaurants %}
                {% with max_nb=top_restaurants.0.nb %}
                {% for r in top_restaurants %}
                <div class="top-item">
                    <div class="top-rank {% if forloop.first %}gold{% endif %}">{{ forloop.counter }}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:11px;font-weight:600;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ r.restaurant__nom|default:"—" }}</div>
                        <div style="display:flex;align-items:center;gap:5px;margin-top:3px;">
                            <div class="top-bar"><div class="top-bar-fill" style="width:{% widthratio r.nb max_nb 100 %}%;"></div></div>
                            <span style="font-size:9px;color:#6b7280;white-space:nowrap;">{{ r.nb }} conso.</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endwith %}
                {% else %}
                <p style="text-align:center;color:#9ca3af;font-size:11px;padding:16px 0;">Aucune donnée de consommation</p>
                {% endif %}
            </div>
        </div>

        {# Rapports disponibles #}
        <div class="dc" style="margin-bottom:0;">
            <div class="dc-head"><i class="fas fa-list"></i> Rapports disponibles</div>
            <div class="dc-body" style="padding:8px 10px;">
                <a href="{% url 'tickets:admin_tickets' %}" class="rp-btn">
                    <div class="rp-icon" style="background:#d1fae5;"><i class="fas fa-ticket-alt" style="color:#28a745;"></i></div>
                    <div><div class="rp-t">Tickets</div><div class="rp-s">Gestion complète</div></div>
                    <span class="rp-arrow">→</span>
                </a>
                <a href="{% url 'transactions:admin_transactions' %}" class="rp-btn">
                    <div class="rp-icon" style="background:#dbeafe;"><i class="fas fa-exchange-alt" style="color:#3b82f6;"></i></div>
                    <div><div class="rp-t">Transactions</div><div class="rp-s">Historique complet</div></div>
                    <span class="rp-arrow">→</span>
                </a>
                <a href="{% url 'accounts:users_list' %}" class="rp-btn">
                    <div class="rp-icon" style="background:#ede7ff;"><i class="fas fa-users" style="color:#6f42c1;"></i></div>
                    <div><div class="rp-t">Employés</div><div class="rp-s">Par direction / agence</div></div>
                    <span class="rp-arrow">→</span>
                </a>
                <a href="{% url 'settings:admin_audit' %}" class="rp-btn">
                    <div class="rp-icon" style="background:#fee2e2;"><i class="fas fa-clipboard-list" style="color:#dc3545;"></i></div>
                    <div><div class="rp-t">Journal d'audit</div><div class="rp-s">Traçabilité système</div></div>
                    <span class="rp-arrow">→</span>
                </a>
            </div>
        </div>
    </div>
</div>

{# ── Récap par agence ── #}
<div class="dc" style="margin-top:10px;">
    <div class="dc-head">
        <i class="fas fa-table"></i> Récapitulatif par agence — {{ filtres.date_debut }} au {{ filtres.date_fin }}
        <div class="exp-btns">
            <a href="{% url 'accounts:export_agencies_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="exp xls"><i class="fas fa-file-excel"></i> Excel</a>
        </div>
    </div>
    <div style="overflow-x:auto;">
        <table class="mt">
            <thead>
                <tr>
                    <th>Agence</th>
                    <th>Direction</th>
                    <th style="text-align:center;">Employés</th>
                    <th style="text-align:center;">Tickets achetés</th>
                    <th style="text-align:center;">Tickets consommés</th>
                    <th style="text-align:center;">Taux conso.</th>
                    <th style="text-align:right;">Montant (FCFA)</th>
                    <th style="text-align:right;">Subvention (FCFA)</th>
                </tr>
            </thead>
            <tbody>
            {% for a in rapport_agences %}
            <tr>
                <td>
                    <div style="font-weight:600;color:#111827;font-size:11px;">{{ a.nom }}</div>
                    <div style="font-size:9px;color:#9ca3af;">{{ a.code }}</div>
                </td>
                <td style="font-size:10px;color:#6b7280;">{{ a.direction.nom|default:"—" }}</td>
                <td style="text-align:center;font-weight:600;">{{ a.nb_employes|default:0 }}</td>
                <td style="text-align:center;font-weight:600;color:#17a2b8;">{{ a.tickets_achetes|default:0 }}</td>
                <td style="text-align:center;font-weight:600;color:#28a745;">{{ a.tickets_consommes|default:0 }}</td>
                <td style="text-align:center;">
                    {% if a.tickets_achetes > 0 %}
                    {% widthratio a.tickets_consommes a.tickets_achetes 100 as pct %}
                    <div style="display:flex;align-items:center;gap:4px;justify-content:center;">
                        <div style="width:50px;background:#f3f4f6;border-radius:3px;height:5px;overflow:hidden;">
                            <div style="width:{{ pct }}%;height:100%;background:{% if pct >= 70 %}#28a745{% elif pct >= 40 %}#ffc107{% else %}#dc3545{% endif %};border-radius:3px;"></div>
                        </div>
                        <span style="font-size:9px;color:#6b7280;">{{ pct }}%</span>
                    </div>
                    {% else %}
                    <span style="color:#d1d5db;font-size:10px;">—</span>
                    {% endif %}
                </td>
                <td style="text-align:right;font-weight:600;">{{ a.montant_total|default:0|floatformat:0 }}</td>
                <td style="text-align:right;font-weight:600;color:#28a745;">{{ a.subvention|default:0|floatformat:0 }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="padding:24px;text-align:center;">
                    <div class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <p>Aucune donnée pour la période sélectionnée</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
            {% if rapport_agences %}
            <tfoot>
                <tr>
                    <td colspan="2" style="font-weight:700;font-size:11px;">TOTAL</td>
                    <td style="text-align:center;">{{ totaux.employes|default:0 }}</td>
                    <td style="text-align:center;color:#17a2b8;">{{ totaux.tickets|default:0 }}</td>
                    <td style="text-align:center;color:#28a745;">{{ totaux.consommes|default:0 }}</td>
                    <td></td>
                    <td style="text-align:right;">{{ totaux.montant|default:0|floatformat:0 }}</td>
                    <td style="text-align:right;color:#28a745;">{{ totaux.subvention|default:0|floatformat:0 }}</td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>
</div>

{% endblock %}

{% block dashboard_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
var labels = [{% for l in graph_labels %}'{{ l }}'{% if not forloop.last %},{% endif %}{% endfor %}];
var dT = [{% for v in graph_mensuel_tickets %}{{ v }}{% if not forloop.last %},{% endif %}{% endfor %}];
var dM = [{% for v in graph_mensuel_montants %}{{ v }}{% if not forloop.last %},{% endif %}{% endfor %}];

/* Fallback si vide */
if (!labels.length) {
    var mois=['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'];
    labels = mois;
    dT = Array(12).fill(0);
    dM = Array(12).fill(0);
}

Chart.defaults.font.size = 10;
new Chart(document.getElementById('rptChart'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Tickets achetés',
                data: dT,
                backgroundColor: 'rgba(40,167,69,.7)',
                borderColor: '#28a745',
                borderWidth: 1,
                borderRadius: 3,
                yAxisID: 'y',
            },
            {
                label: 'Montants (kFCFA)',
                data: dM.map(v => +(v/1000).toFixed(1)),
                type: 'line',
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23,162,184,.06)',
                tension: 0.3,
                fill: false,
                pointRadius: 3,
                borderWidth: 1.5,
                yAxisID: 'y2',
            }
        ]
    },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10, font: { size: 10 } } }
        },
        scales: {
            y:  { beginAtZero: true, grid: { color: 'rgba(0,0,0,.04)' }, ticks: { font: { size: 9 } }, title: { display: true, text: 'Tickets', font: { size: 9 } } },
            y2: { beginAtZero: true, position: 'right', grid: { display: false }, ticks: { font: { size: 9 } }, title: { display: true, text: 'kFCFA', font: { size: 9 } } },
            x:  { grid: { display: false }, ticks: { font: { size: 9 } } }
        }
    }
});
</script>
{% endblock %}