{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Journal d'Audit — Administration{% endblock %}
{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
    .dc{background:#fff;border-radius:7px;box-shadow:0 1px 3px rgba(0,0,0,.07);overflow:hidden;margin-bottom:8px;}
    .dc-head{padding:8px 12px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;color:#374151;}
    .dc-head i{color:#28a745;font-size:10px;}
    .filter-bar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;padding:8px 12px;border-bottom:1px solid #f3f4f6;}
    .filter-bar select,.filter-bar input{padding:4px 7px;border:1px solid #e5e7eb;border-radius:5px;font-size:10px;color:#374151;outline:none;}
    .filter-bar select:focus,.filter-bar input:focus{border-color:#28a745;}
    .btn-xs{padding:4px 10px;font-size:10px;border-radius:4px;border:none;cursor:pointer;font-weight:600;}
    .btn-g{background:#28a745;color:#fff;} .btn-o{background:#fff;border:1px solid #e5e7eb;color:#374151;text-decoration:none;}
    .ab{display:inline-flex;align-items:center;padding:2px 6px;border-radius:8px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
    .ab-cre{background:#d1fae5;color:#065f46;}
    .ab-mod{background:#dbeafe;color:#1e40af;}
    .ab-sup{background:#fee2e2;color:#991b1b;}
    .ab-con{background:#f0fdf4;color:#166534;}
    .ab-dec{background:#f3f4f6;color:#6b7280;}
    .ab-ach{background:#fef3c7;color:#92400e;}
    .ab-cso{background:#ede7ff;color:#5b21b6;}
    .ab-def{background:#f3f4f6;color:#374151;}
    .stat-pill{display:inline-flex;align-items:center;gap:4px;padding:5px 9px;background:#f9fafb;border:1px solid #f3f4f6;border-radius:5px;font-size:10px;}
    .stat-pill strong{font-size:13px;font-weight:800;color:#111827;}
    .mt{width:100%;border-collapse:collapse;}
    .mt th{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#9ca3af;padding:6px 8px;border-bottom:1px solid #f3f4f6;text-align:left;}
    .mt td{font-size:10px;padding:6px 8px;border-bottom:1px solid #fafafa;color:#374151;vertical-align:middle;}
    .mt tr:last-child td{border-bottom:none;}
    .mt tr:hover td{background:#fafafa;}
    .pg{display:flex;gap:4px;justify-content:center;align-items:center;padding:8px;border-top:1px solid #f3f4f6;}
    .pg a,.pg span{padding:3px 8px;border:1px solid #e5e7eb;border-radius:4px;font-size:10px;color:#374151;text-decoration:none;}
    .pg a:hover{border-color:#28a745;color:#28a745;}
</style>{% endblock %}

{% block sidebar_menu %}{% include 'dashboards/sidebars/admin_sidebar.html' %}{% endblock %}

{% block page_content %}
<div class="page-header" style="margin-bottom:12px;">
    <h1 class="page-title" style="font-size:17px;">Journal d'Audit</h1>
    <p class="page-subtitle" style="font-size:11px;">Traçabilité complète des actions système</p>
</div>

<div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:8px;">
    <div class="stat-pill"><strong>{{ total_entrees|default:0 }}</strong> entrées totales</div>
    <div class="stat-pill"><strong>{{ entrees_aujourd_hui|default:0 }}</strong> aujourd'hui</div>
    <div class="stat-pill"><strong>{{ entrees_semaine|default:0 }}</strong> cette semaine</div>
    <div class="stat-pill"><strong>{{ nb_utilisateurs_actifs|default:0 }}</strong> utilisateurs actifs</div>
</div>

<div class="dc">
    <div class="dc-head"><i class="fas fa-clipboard-list"></i> Entrées du journal</div>
    <form method="get">
        <div class="filter-bar">
            <input type="text" name="search" value="{{ filtres.search|default:'' }}" placeholder="Rechercher..."
                   style="min-width:160px;">
            <select name="action">
                <option value="">Toutes actions</option>
                <option value="CREATION" {% if filtres.action == 'CREATION' %}selected{% endif %}>Création</option>
                <option value="MODIFICATION" {% if filtres.action == 'MODIFICATION' %}selected{% endif %}>Modification</option>
                <option value="SUPPRESSION" {% if filtres.action == 'SUPPRESSION' %}selected{% endif %}>Suppression</option>
                <option value="CONNEXION" {% if filtres.action == 'CONNEXION' %}selected{% endif %}>Connexion</option>
                <option value="DECONNEXION" {% if filtres.action == 'DECONNEXION' %}selected{% endif %}>Déconnexion</option>
                <option value="ACHAT" {% if filtres.action == 'ACHAT' %}selected{% endif %}>Achat</option>
                <option value="CONSOMMATION" {% if filtres.action == 'CONSOMMATION' %}selected{% endif %}>Consommation</option>
            </select>
            <select name="modele">
                <option value="">Tous modèles</option>
                <option value="Utilisateur" {% if filtres.modele == 'Utilisateur' %}selected{% endif %}>Utilisateur</option>
                <option value="Ticket" {% if filtres.modele == 'Ticket' %}selected{% endif %}>Ticket</option>
                <option value="Transaction" {% if filtres.modele == 'Transaction' %}selected{% endif %}>Transaction</option>
                <option value="Restaurant" {% if filtres.modele == 'Restaurant' %}selected{% endif %}>Restaurant</option>
                <option value="Menu" {% if filtres.modele == 'Menu' %}selected{% endif %}>Menu</option>
            </select>
            <input type="date" name="date_debut" value="{{ filtres.date_debut|default:'' }}">
            <input type="date" name="date_fin" value="{{ filtres.date_fin|default:'' }}">
            <button type="submit" class="btn-xs btn-g">Filtrer</button>
            <a href="{% url 'settings:admin_audit' %}" class="btn-xs btn-o">Reset</a>
        </div>
    </form>

    <div style="overflow-x:auto;">
        <table class="mt">
            <thead>
            <tr>
                <th>Date/Heure</th>
                <th>Utilisateur</th>
                <th>Action</th>
                <th>Modèle</th>
                <th>Description</th>
                <th>IP</th>
            </tr>
            </thead>
            <tbody>
            {% for e in entrees %}
            <tr>
                <td style="white-space:nowrap;color:#9ca3af;">{{ e.cree_le|date:"d/m/Y H:i:s" }}</td>
                <td style="font-weight:600;color:#111827;">
                    {% if e.utilisateur %}{{ e.utilisateur.get_full_name|truncatechars:18 }}
                    {% else %}<span style="color:#9ca3af;">Système</span>{% endif %}
                </td>
                <td>
                    <span class="ab ab-{% if e.action == 'CREATION' %}cre{% elif e.action == 'MODIFICATION' %}mod{% elif e.action == 'SUPPRESSION' %}sup{% elif e.action == 'CONNEXION' %}con{% elif e.action == 'DECONNEXION' %}dec{% elif e.action == 'ACHAT' %}ach{% elif e.action == 'CONSOMMATION' %}cso{% else %}def{% endif %}">
                        {{ e.get_action_display }}
                    </span>
                </td>
                <td style="color:#6b7280;">{{ e.modele }}</td>
                <td style="max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                    title="{{ e.description }}">{{ e.description|truncatechars:55 }}
                </td>
                <td style="font-family:monospace;color:#9ca3af;">{{ e.adresse_ip|default:"—" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="padding:20px;text-align:center;color:#9ca3af;font-size:10px;">
                    <i class="fas fa-clipboard" style="font-size:18px;display:block;margin-bottom:5px;opacity:.3;"></i>
                    Aucune entrée dans le journal
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if page_obj.has_other_pages %}
    <div class="pg">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if filtres.search %}&search={{ filtres.search }}{% endif %}{% if filtres.action %}&action={{ filtres.action }}{% endif %}">‹
            Préc.</a>
        {% endif %}
        <span style="border-color:transparent;font-size:10px;color:#6b7280;">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if filtres.search %}&search={{ filtres.search }}{% endif %}{% if filtres.action %}&action={{ filtres.action }}{% endif %}">Suiv.
            ›</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}