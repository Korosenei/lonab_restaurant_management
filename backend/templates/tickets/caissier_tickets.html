{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Tickets{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
{% endblock %}

{% block sidebar_menu %}
{% include 'dashboards/sidebars/caissier_sidebar.html' %}
{% endblock %}

{% block page_content %}
<div id="ticket-urls"
     data-vente-url="{% url 'transactions:caissier_confirmer_vente' %}"
     data-debut-mois="{{ debut_mois|date:'Y-m-d' }}"
     data-fin-mois="{{ fin_mois|date:'Y-m-d' }}"
     data-prix="{{ prix_ticket }}"
     data-subvention="{{ subvention }}"
     data-min-tickets="{{ min_tickets|default:1 }}"
     data-max-tickets="{{ max_tickets|default:22 }}"
     style="display:none;"></div>

<div class="page-header-with-actions">
    <div class="page-header">
        <h1 class="page-title">Tickets</h1>
        <p class="page-subtitle">{{ total_tickets }} ticket{{ total_tickets|pluralize }}</p>
    </div>
    <div class="page-header-actions">
        <button class="export-btn export-btn-pdf"
                onclick="exportToPDF('ticketsTable','tickets.pdf')" title="PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button class="export-btn export-btn-excel"
                onclick="exportToExcel('ticketsTable','tickets.xlsx')" title="Excel">
            <i class="fas fa-file-excel"></i>
        </button>
        <button class="export-btn export-btn-csv"
                onclick="exportToCSV('ticketsTable','tickets.csv')" title="CSV">
            <i class="fas fa-file-csv"></i>
        </button>
        <button class="btn btn-primary" onclick="openModal('venteModal')">
            <i class="fas fa-plus"></i> Nouvelle vente
        </button>
    </div>
</div>

<div class="toolbar">
    <div class="toolbar-left">
        <div class="toolbar-search">
            <i class="fas fa-search"></i>
            <input type="text" id="tableSearch" placeholder="Rechercher...">
        </div>
        <div class="toolbar-filter">
            <select name="statut" onchange="applyTicketFilters()">
                <option value="">Tous statuts</option>
                <option value="DISPONIBLE" {% if request.GET.statut == 'DISPONIBLE' %}selected{% endif %}>Disponible</option>
                <option value="CONSOMME"   {% if request.GET.statut == 'CONSOMME'   %}selected{% endif %}>Consommé</option>
                <option value="EXPIRE"     {% if request.GET.statut == 'EXPIRE'     %}selected{% endif %}>Expiré</option>
                <option value="ANNULE"     {% if request.GET.statut == 'ANNULE'     %}selected{% endif %}>Annulé</option>
            </select>
        </div>
        <div class="toolbar-filter">
            <input type="month" name="mois" value="{{ request.GET.mois }}"
                   onchange="applyTicketFilters()" title="Mois de validité"
                   style="padding:5px 8px;border:1px solid #dee2e6;border-radius:4px;font-size:12px;">
        </div>
        {% if request.GET.statut or request.GET.mois or request.GET.search %}
        <a href="{% url 'tickets:caissier_tickets' %}" class="btn btn-outline" title="Réinitialiser les filtres"
           style="height:28px;padding:0 10px;font-size:12px;display:inline-flex;align-items:center;gap:5px;">
            <i class="fas fa-times"></i> Reset
        </a>
        {% endif %}
    </div>
</div>

<div class="data-table-wrapper">
    <div class="data-table-body">
        <div class="table-responsive">
            <table class="table" id="ticketsTable">
                <thead>
                    <tr>
                        <th data-sortable style="width:40px;">#</th>
                        <th data-sortable>N° Ticket</th>
                        <th data-sortable>Propriétaire</th>
                        <th data-sortable>Agence</th>
                        <th data-sortable>Validité</th>
                        <th data-sortable>Statut</th>
                        <th data-sortable>Consommé chez</th>
                    </tr>
                </thead>
                <tbody>
                {% for t in tickets %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <span style="font-family:monospace;font-size:12px;font-weight:700;color:#28a745;">
                            {{ t.numero_ticket }}
                        </span>
                    </td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div style="width:28px;height:28px;background:var(--light-green);border-radius:50%;
                                        display:flex;align-items:center;justify-content:center;
                                        font-weight:700;color:var(--primary-green);font-size:10px;flex-shrink:0;">
                                {{ t.proprietaire.prenom.0 }}{{ t.proprietaire.nom.0 }}
                            </div>
                            <div>
                                <div style="font-weight:600;font-size:12px;">{{ t.proprietaire.get_full_name }}</div>
                                {% if t.proprietaire.matricule %}
                                <div style="font-size:10px;color:var(--text-muted);">{{ t.proprietaire.matricule }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td style="font-size:11px;">{{ t.proprietaire.agence.nom|default:"—" }}</td>
                    <td style="font-size:12px;color:var(--text-muted);">
                        {{ t.valide_de|date:"d/m" }} → {{ t.valide_jusqua|date:"d/m/Y" }}
                    </td>
                    <td>
                        {% if t.statut == 'DISPONIBLE' %}
                            <span class="badge badge-success" style="font-size:10px;">Disponible</span>
                        {% elif t.statut == 'CONSOMME' %}
                            <span class="badge" style="background:#6c757d;color:white;font-size:10px;">Consommé</span>
                        {% elif t.statut == 'EXPIRE' %}
                            <span class="badge badge-warning" style="font-size:10px;">Expiré</span>
                        {% else %}
                            <span class="badge badge-danger" style="font-size:10px;">Annulé</span>
                        {% endif %}
                    </td>
                    <td style="font-size:12px;color:var(--text-muted);">
                        {% if t.restaurant_consommateur %}
                            <i class="fas fa-utensils" style="color:var(--primary-green);margin-right:4px;"></i>
                            {{ t.restaurant_consommateur.nom }}
                            {% if t.date_consommation %}
                            <div style="font-size:10px;color:var(--text-muted);">{{ t.date_consommation|date:"d/m/Y H:i" }}</div>
                            {% endif %}
                        {% else %}—{% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="fas fa-ticket-alt"></i>
                            <p>Aucun ticket trouvé</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if is_paginated %}
    <div class="pagination-wrapper">
        <div class="pagination-info">
            Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
        </div>
        <div class="pagination">
            {% if page_obj.has_previous %}
            <button class="pagination-btn"
                    onclick="window.location.href='?page={{ page_obj.previous_page_number }}'">
                <i class="fas fa-chevron-left"></i>
            </button>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            <button class="pagination-btn {% if page_obj.number == num %}active{% endif %}"
                    onclick="window.location.href='?page={{ num }}'">{{ num }}</button>
            {% endfor %}
            {% if page_obj.has_next %}
            <button class="pagination-btn"
                    onclick="window.location.href='?page={{ page_obj.next_page_number }}'">
                <i class="fas fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% include 'tickets/modals/vente_form.html' %}
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    initDataTable('ticketsTable');

    var u    = document.getElementById('ticket-urls').dataset;
    var PRIX = parseFloat(u.prix);
    var MIN  = parseInt(u.minTickets);
    var MAX  = parseInt(u.maxTickets);

    /* ── Filtrer la liste clients dans le modal ─────────────── */
    window.filtrerClients = function (val) {
        val = val.toLowerCase();
        document.querySelectorAll('.client-row').forEach(function (el) {
            /* Ne jamais afficher les clients déjà éligibles (masqués) */
            if (el.dataset.eligible === 'false') return;
            el.style.display = (!val || (el.dataset.search || '').includes(val)) ? '' : 'none';
        });
    };

    /* ── Sélectionner un client ─────────────────────────────── */
    window.selectClient = function (el) {
        document.querySelectorAll('.client-row').forEach(function (r) { r.style.background = ''; });
        el.style.background = 'var(--light-green)';
        document.getElementById('clientId').value = el.dataset.id;
        document.getElementById('clientSelectedName').textContent =
            el.dataset.nom + (el.dataset.matricule ? ' — ' + el.dataset.matricule : '');
        document.getElementById('clientSelected').style.display = 'block';
        updateBtn();
    };

    /* ── Presets nombre de tickets ──────────────────────────── */
    window.setNb = function (n) {
        document.getElementById('nbTickets').value = n;
        majRecap();
    };

    /* ── Recalcul récapitulatif ─────────────────────────────── */
    window.majRecap = function () {
        var raw = parseInt(document.getElementById('nbTickets').value) || MIN;
        var nb  = Math.min(MAX, Math.max(MIN, raw));
        document.getElementById('nbTickets').value = nb;
        document.getElementById('totalDisplay').textContent =
            (nb * PRIX).toLocaleString('fr-FR') + ' FCFA';
        updateBtn();
    };

    function updateBtn() {
        var ok = !!document.getElementById('clientId').value &&
                 parseInt(document.getElementById('nbTickets').value) >= MIN;
        document.getElementById('btnValider').disabled = !ok;
    }

    /* ── Soumettre la vente ─────────────────────────────────── */
    window.soumettreVente = function () {
        var clientId = document.getElementById('clientId').value;
        var nb       = parseInt(document.getElementById('nbTickets').value);
        if (!clientId || nb < MIN) { showWarning('Vérifiez le formulaire'); return; }

        var btn = document.getElementById('btnValider');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';

        var fd = new FormData();
        fd.append('client_id',      clientId);
        fd.append('nombre_tickets', nb);
        fd.append('notes',          document.getElementById('ventNotes').value || '');

        fetch(u.venteUrl, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: fd,
        })
        .then(function (r) { return r.json(); })
        .then(function (d) {
            if (d.success) {
                showSuccess(d.message || 'Vente enregistrée');
                closeModal('venteModal');
                setTimeout(function () { window.location.reload(); }, 800);
            } else {
                showError(d.error || 'Erreur lors de la vente');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Valider la vente';
            }
        })
        .catch(function () {
            showError('Erreur réseau');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Valider la vente';
        });
    };

    /* ── Filtres toolbar (URL params) ───────────────────────── */
    window.applyTicketFilters = function () {
        var params = new URLSearchParams();
        document.querySelectorAll('.toolbar-filter select, .toolbar-filter input').forEach(function (el) {
            if (el.name && el.value) params.append(el.name, el.value);
        });
        window.location.search = params.toString();
    };

    /* ── Init récap ─────────────────────────────────────────── */
    majRecap();
});
</script>
{% endblock %}