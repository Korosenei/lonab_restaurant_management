{% load custom_filters %}

<div class="modal" id="venteModal">
    <div class="modal-content" style="max-width:500px;">
        <div class="modal-header">
            <h3><i class="fas fa-ticket-alt" style="margin-right:8px;"></i> Nouvelle vente de tickets</h3>
            <button type="button" class="close-btn" onclick="closeModal('venteModal')">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Client sélectionné -->
            <input type="hidden" id="clientId" value="">

            <div class="form-group">
                <label style="font-weight:600;margin-bottom:5px;display:block;">
                    <i class="fas fa-user" style="margin-right:5px;"></i> Client
                </label>

                <!-- Recherche client -->
                <div style="position:relative;margin-bottom:8px;">
                    <i class="fas fa-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#adb5bd;"></i>
                    <input type="text"
                           id="clientSearch"
                           class="form-control"
                           placeholder="Rechercher un client (nom, matricule...)"
                           style="padding-left:35px;"
                           oninput="filtrerClients(this.value)">
                </div>

                <!-- Liste des clients -->
                <div style="max-height:200px;overflow-y:auto;border:1px solid #dee2e6;border-radius:5px;margin-bottom:8px;">
                    {% for client in clients %}
                    <div class="client-row"
                         data-id="{{ client.id }}"
                         data-search="{{ client.nom|lower }} {{ client.prenom|lower }} {{ client.matricule|default:''|lower }}"
                         data-nom="{{ client.get_full_name }}"
                         data-matricule="{{ client.matricule|default:'' }}"
                         data-eligible="true"
                         style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #f1f3f5;transition:all .15s;"
                         onclick="selectClient(this)"
                         onmouseover="this.style.background='#f8f9fa'"
                         onmouseout="this.style.background=''">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="width:32px;height:32px;background:var(--light-green);border-radius:50%;
                                        display:flex;align-items:center;justify-content:center;
                                        font-weight:700;color:var(--primary-green);">
                                {{ client.prenom.0 }}{{ client.nom.0 }}
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:13px;">{{ client.get_full_name }}</div>
                                <div style="font-size:11px;color:#6c757d;">
                                    {% if client.matricule %}Matricule: {{ client.matricule }}{% endif %}
                                    {% if client.agence %} • {{ client.agence.nom }}{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div style="padding:20px;text-align:center;color:#6c757d;">
                        <i class="fas fa-users" style="font-size:24px;margin-bottom:8px;opacity:0.5;"></i>
                        <p>Aucun client disponible</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Client sélectionné (affiché) -->
                <div id="clientSelected" style="display:none;margin-top:8px;padding:8px;background:#e8f5e9;border-radius:5px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <div>
                            <i class="fas fa-check-circle" style="color:#28a745;"></i>
                            <span id="clientSelectedName"></span>
                        </div>
                        <button type="button" style="background:none;border:none;color:#dc3545;cursor:pointer;"
                                onclick="document.getElementById('clientSelected').style.display='none';document.getElementById('clientId').value='';">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Nombre de tickets -->
            <div class="form-group" style="margin-top:15px;">
                <label style="font-weight:600;margin-bottom:5px;display:block;">
                    <i class="fas fa-calculator" style="margin-right:5px;"></i> Nombre de tickets
                </label>

                <input type="number" id="nbTickets"
                       class="form-control"
                       value="{{ max_tickets|default:22 }}"
                       min="{{ min_tickets|default:1 }}"
                       max="{{ max_tickets|default:22 }}"
                       style="font-size:20px;font-weight:700;text-align:center;"
                       oninput="majRecap()">

                {# Boutons preset avec filtre split personnalisé #}
                <div style="display:flex;gap:6px;margin-top:6px;">
                    {% for preset in "5,10,15,22"|split:"," %}
                    <button type="button"
                            onclick="setNb({{ preset }})"
                            style="flex:1;padding:5px 0;border:1.5px solid #dee2e6;border-radius:5px;
                                   background:white;font-size:12px;font-weight:700;cursor:pointer;
                                   color:#495057;transition:all .15s;"
                            onmouseover="this.style.borderColor='#28a745';this.style.color='#28a745';"
                            onmouseout="this.style.borderColor='#dee2e6';this.style.color='#495057';">
                        {{ preset }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Récapitulatif -->
            <div style="background:#f8f9fa;padding:12px;border-radius:5px;margin:15px 0;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-weight:600;">Total à payer :</span>
                    <span id="totalDisplay" style="font-size:22px;font-weight:700;color:#28a745;">0 FCFA</span>
                </div>
                <div style="font-size:11px;color:#6c757d;margin-top:5px;">
                    * Prix unitaire : {{ prix_ticket }} FCFA (dont subvention {{ subvention }} FCFA)
                </div>
            </div>

            <!-- Notes optionnelles -->
            <div class="form-group">
                <label style="font-weight:600;margin-bottom:5px;display:block;">
                    <i class="fas fa-sticky-note" style="margin-right:5px;"></i> Notes (optionnel)
                </label>
                <textarea id="ventNotes" class="form-control" rows="2"
                          placeholder="Ajouter une note à cette vente..."></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeModal('venteModal')">
                <i class="fas fa-times"></i> Annuler
            </button>
            <button type="button" class="btn btn-primary" id="btnValider" onclick="soumettreVente()" disabled>
                <i class="fas fa-check-circle"></i> Valider la vente
            </button>
        </div>
    </div>
</div>

<style>
/* Styles supplémentaires pour le modal */
.client-row:hover {
    background: #f8f9fa;
}
.client-row:last-child {
    border-bottom: none !important;
}
</style>