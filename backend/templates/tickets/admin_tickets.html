{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Tickets — Admin{% endblock %}
{% block dashboard_css %}<link rel="stylesheet" href="{% static 'css/components.css' %}">{% endblock %}
{% block sidebar_menu %}{% include 'dashboards/sidebars/admin_sidebar.html' %}{% endblock %}

{% block page_content %}

<!-- En-tête -->
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
    <div>
        <h1 style="font-size:22px;font-weight:700;color:var(--text-primary);margin:0;">
            <i class="fas fa-ticket-alt" style="color:var(--primary-green);margin-right:10px;"></i>Tickets
        </h1>
        <p style="color:var(--text-muted);font-size:13px;margin:4px 0 0;">
            {{ page_obj.paginator.count }} ticket(s) trouvé(s) selon les filtres
        </p>
    </div>
    <a href="{% url 'tickets:admin_stats' %}" class="btn btn-outline">
        <i class="fas fa-chart-bar"></i> Statistiques
    </a>
</div>

<!-- Stats pills -->
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;">
    <div style="background:white;border-radius:20px;padding:8px 16px;box-shadow:0 1px 6px rgba(0,0,0,.07);font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:8px;">
        <span style="color:var(--text-muted);">Total (filtré)</span>
        <span style="color:var(--text-primary);">{{ totaux.total }}</span>
    </div>
    <div style="background:white;border-radius:20px;padding:8px 16px;box-shadow:0 1px 6px rgba(0,0,0,.07);font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:8px;">
        <span style="width:8px;height:8px;border-radius:50%;background:#28a745;display:inline-block;"></span>
        <span>{{ totaux.disponibles }} disponibles</span>
    </div>
    <div style="background:white;border-radius:20px;padding:8px 16px;box-shadow:0 1px 6px rgba(0,0,0,.07);font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:8px;">
        <span style="width:8px;height:8px;border-radius:50%;background:#1976d2;display:inline-block;"></span>
        <span>{{ totaux.consommes }} consommés</span>
    </div>
    <div style="background:white;border-radius:20px;padding:8px 16px;box-shadow:0 1px 6px rgba(0,0,0,.07);font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:8px;">
        <span style="width:8px;height:8px;border-radius:50%;background:#f57c00;display:inline-block;"></span>
        <span>{{ totaux.expires }} expirés</span>
    </div>
    <div style="background:white;border-radius:20px;padding:8px 16px;box-shadow:0 1px 6px rgba(0,0,0,.07);font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:8px;">
        <span style="color:var(--text-muted);">Vendus ce mois</span>
        <span style="color:var(--primary-green);">{{ totaux.vendus_mois }}</span>
    </div>
    <div style="background:white;border-radius:20px;padding:8px 16px;box-shadow:0 1px 6px rgba(0,0,0,.07);font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:8px;">
        <span style="color:var(--text-muted);">Consommés ce mois</span>
        <span style="color:#1976d2;">{{ totaux.consommes_mois }}</span>
    </div>
</div>

<!-- Filtres -->
<div class="card" style="padding:14px 16px;margin-bottom:18px;">
    <form method="get" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;align-items:flex-end;">
        <!-- Recherche -->
        <div>
            <label style="font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;display:block;margin-bottom:4px;">Recherche</label>
            <div style="position:relative;">
                <i class="fas fa-search" style="position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:12px;"></i>
                <input type="text" name="search" value="{{ request.GET.search|default:'' }}"
                       placeholder="N°, client, matricule..."
                       style="padding:8px 8px 8px 30px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;width:100%;box-sizing:border-box;">
            </div>
        </div>
        <!-- Statut -->
        <div>
            <label style="font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;display:block;margin-bottom:4px;">Statut</label>
            <select name="statut" style="padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;width:100%;">
                <option value="">Tous</option>
                {% for v,l in statuts %}
                <option value="{{ v }}" {% if request.GET.statut == v %}selected{% endif %}>{{ l }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Agence -->
        <div>
            <label style="font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;display:block;margin-bottom:4px;">Agence</label>
            <select name="agence" style="padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;width:100%;">
                <option value="">Toutes</option>
                {% for a in agences %}
                <option value="{{ a.id }}" {% if request.GET.agence == a.id|stringformat:"s" %}selected{% endif %}>{{ a.nom }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Mois validité -->
        <div>
            <label style="font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;display:block;margin-bottom:4px;">Mois validité</label>
            <input type="month" name="mois" value="{{ request.GET.mois|default:'' }}"
                   style="padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;width:100%;box-sizing:border-box;">
        </div>
        <!-- Période de création -->
        <div>
            <label style="font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;display:block;margin-bottom:4px;">Créé du</label>
            <input type="date" name="date_debut" value="{{ request.GET.date_debut|default:'' }}"
                   style="padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;width:100%;box-sizing:border-box;">
        </div>
        <div>
            <label style="font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;display:block;margin-bottom:4px;">Au</label>
            <input type="date" name="date_fin" value="{{ request.GET.date_fin|default:'' }}"
                   style="padding:8px 10px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;width:100%;box-sizing:border-box;">
        </div>
        <!-- Boutons -->
        <div style="display:flex;gap:6px;align-items:flex-end;">
            <button type="submit" class="btn btn-secondary" style="flex:1;">
                <i class="fas fa-filter"></i> Filtrer
            </button>
            {% if request.GET.search or request.GET.statut or request.GET.agence or request.GET.mois or request.GET.date_debut or request.GET.date_fin %}
            <a href="{% url 'tickets:admin_tickets' %}" class="btn" style="background:var(--light-green);color:var(--primary-green);">
                <i class="fas fa-times"></i>
            </a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Tableau -->
<div class="card" style="overflow:hidden;">
    <table style="width:100%;border-collapse:collapse;">
        <thead>
            <tr style="background:var(--bg-light);border-bottom:2px solid var(--border-color);">
                <th style="padding:11px 14px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">N° Ticket</th>
                <th style="padding:11px 14px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Propriétaire</th>
                <th style="padding:11px 14px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Agence</th>
                <th style="padding:11px 14px;text-align:center;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Validité</th>
                <th style="padding:11px 14px;text-align:center;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Statut</th>
                <th style="padding:11px 14px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Consommé le</th>
                <th style="padding:11px 14px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Restaurant</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in tickets %}
            <tr style="border-top:1px solid var(--border-color);"
                onmouseover="this.style.background='var(--bg-light)'" onmouseout="this.style.background=''">
                <td style="padding:11px 14px;font-family:monospace;font-size:12px;font-weight:700;color:var(--primary-green);">{{ ticket.numero_ticket }}</td>
                <td style="padding:11px 14px;">
                    <div style="font-weight:600;font-size:13px;">{{ ticket.proprietaire.get_full_name }}</div>
                    <div style="font-size:11px;color:var(--text-muted);">{{ ticket.proprietaire.matricule|default:"—" }}</div>
                </td>
                <td style="padding:11px 14px;font-size:12px;color:var(--text-secondary);">{{ ticket.proprietaire.agence.nom|default:"—" }}</td>
                <td style="padding:11px 14px;text-align:center;font-size:12px;color:var(--text-secondary);">
                    {{ ticket.valide_de|date:"d/m" }} → {{ ticket.valide_jusqua|date:"d/m/Y" }}
                </td>
                <td style="padding:11px 14px;text-align:center;">
                    {% if ticket.statut == 'DISPONIBLE' %}<span style="background:#e8f5e9;color:#28a745;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;">Disponible</span>
                    {% elif ticket.statut == 'CONSOMME' %}<span style="background:#e3f2fd;color:#1976d2;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;">Consommé</span>
                    {% elif ticket.statut == 'EXPIRE' %}<span style="background:#fff3e0;color:#f57c00;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;">Expiré</span>
                    {% else %}<span style="background:#ffebee;color:#c62828;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;">Annulé</span>{% endif %}
                </td>
                <td style="padding:11px 14px;font-size:12px;color:var(--text-secondary);">
                    {% if ticket.date_consommation %}{{ ticket.date_consommation|date:"d/m/Y H:i" }}{% else %}—{% endif %}
                </td>
                <td style="padding:11px 14px;font-size:12px;color:var(--text-secondary);">{{ ticket.restaurant_consommateur.nom|default:"—" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="padding:48px;text-align:center;color:var(--text-muted);">
                    <i class="fas fa-ticket-alt" style="font-size:36px;opacity:.25;display:block;margin-bottom:12px;"></i>
                    Aucun ticket trouvé pour ces critères
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% include 'components/pagination.html' with page_obj=page_obj label="ticket(s)" %}
</div>

{% endblock %}