{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Gestion des Tickets{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
{% endblock %}

{% block sidebar_menu %}
{% include 'dashboards/sidebars/admin_sidebar.html' %}
{% endblock %}

{% block page_content %}
<div class="page-header-with-actions">
    <div class="page-header">
        <h1 class="page-title">Gestion des Tickets</h1>
        <p class="page-subtitle">{{ totaux.total }} ticket{{ totaux.total|pluralize }} au total</p>
    </div>
    <div class="page-header-actions">
        <button class="export-btn export-btn-pdf" onclick="exportToPDF('ticketsTable','tickets.pdf')" title="PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button class="export-btn export-btn-excel" onclick="exportToExcel('ticketsTable','tickets.xlsx')" title="Excel">
            <i class="fas fa-file-excel"></i>
        </button>
        <button class="export-btn export-btn-csv" onclick="exportToCSV('ticketsTable','tickets.csv')" title="CSV">
            <i class="fas fa-file-csv"></i>
        </button>
        <a href="{% url 'tickets:admin_stats' %}" class="btn btn-outline">
            <i class="fas fa-chart-bar"></i> Statistiques
        </a>
    </div>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card stat-card-green">
        <div class="stat-card-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-card-content">
            <div class="stat-card-label">Disponibles</div>
            <div class="stat-card-value">{{ totaux.disponibles }}</div>
        </div>
    </div>
    <div class="stat-card stat-card-blue">
        <div class="stat-card-icon"><i class="fas fa-utensils"></i></div>
        <div class="stat-card-content">
            <div class="stat-card-label">Consommés (total)</div>
            <div class="stat-card-value">{{ totaux.consommes }}</div>
        </div>
    </div>
    <div class="stat-card stat-card-yellow">
        <div class="stat-card-icon"><i class="fas fa-ticket-alt"></i></div>
        <div class="stat-card-content">
            <div class="stat-card-label">Vendus ce mois</div>
            <div class="stat-card-value">{{ totaux.vendus_mois }}</div>
        </div>
    </div>
    <div class="stat-card stat-card-red">
        <div class="stat-card-icon"><i class="fas fa-times-circle"></i></div>
        <div class="stat-card-content">
            <div class="stat-card-label">Expirés</div>
            <div class="stat-card-value">{{ totaux.expires }}</div>
        </div>
    </div>
</div>

<!-- Filtres -->
<div class="toolbar">
    <div class="toolbar-left">
        <div class="toolbar-search">
            <i class="fas fa-search"></i>
            <input type="text" id="tableSearch" placeholder="Rechercher...">
        </div>
        <form method="get" style="display:contents;">
            <div class="toolbar-filter">
                <select name="statut" onchange="this.form.submit()">
                    <option value="">Tous statuts</option>
                    <option value="DISPONIBLE" {% if request.GET.statut == 'DISPONIBLE' %}selected{% endif %}>Disponible</option>
                    <option value="CONSOMME"   {% if request.GET.statut == 'CONSOMME'   %}selected{% endif %}>Consommé</option>
                    <option value="EXPIRE"     {% if request.GET.statut == 'EXPIRE'     %}selected{% endif %}>Expiré</option>
                    <option value="ANNULE"     {% if request.GET.statut == 'ANNULE'     %}selected{% endif %}>Annulé</option>
                </select>
            </div>
            <div class="toolbar-filter">
                <input type="month" name="mois" value="{{ request.GET.mois }}"
                       onchange="this.form.submit()" title="Mois de validité">
            </div>
            {% if request.GET.statut or request.GET.mois %}
            <a href="{% url 'tickets:admin_tickets' %}" class="btn btn-outline" title="Réinitialiser">
                <i class="fas fa-times"></i>
            </a>
            {% endif %}
        </form>
    </div>
</div>

<!-- Tableau -->
<div class="data-table-wrapper">
    <div class="data-table-body">
        <div class="table-responsive">
            <table class="table" id="ticketsTable">
                <thead>
                    <tr>
                        <th data-sortable>N° Ticket</th>
                        <th data-sortable>Propriétaire</th>
                        <th data-sortable>Agence</th>
                        <th data-sortable>Validité</th>
                        <th data-sortable>Statut</th>
                        <th data-sortable>Consommé chez</th>
                        <th data-sortable>Prix payé</th>
                    </tr>
                </thead>
                <tbody>
                {% for t in tickets %}
                <tr>
                    <td><code class="ticket-number">{{ t.numero_ticket }}</code></td>
                    <td>
                        <div class="user-cell">
                            <div class="user-avatar-sm">{{ t.proprietaire.prenom.0 }}{{ t.proprietaire.nom.0 }}</div>
                            <div>
                                <div class="user-name">{{ t.proprietaire.get_full_name }}</div>
                                <div class="user-meta">{{ t.proprietaire.matricule|default:"—" }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="text-sm text-muted">{{ t.proprietaire.agence.nom|default:"—" }}</td>
                    <td class="text-sm text-muted">{{ t.valide_de|date:"d/m" }} → {{ t.valide_jusqua|date:"d/m/Y" }}</td>
                    <td>
                        {% if t.statut == 'DISPONIBLE' %}
                        <span class="badge badge-success">Disponible</span>
                        {% elif t.statut == 'CONSOMME' %}
                        <span class="badge badge-secondary">Consommé</span>
                        {% elif t.statut == 'EXPIRE' %}
                        <span class="badge badge-warning">Expiré</span>
                        {% else %}
                        <span class="badge badge-danger">Annulé</span>
                        {% endif %}
                    </td>
                    <td class="text-sm text-muted">
                        {% if t.restaurant_consommateur %}
                        <i class="fas fa-utensils text-green"></i>
                        {{ t.restaurant_consommateur.nom }}
                        {% if t.date_consommation %}
                        <div class="user-meta">{{ t.date_consommation|date:"d/m/Y" }}</div>
                        {% endif %}
                        {% else %}—{% endif %}
                    </td>
                    <td class="text-sm">{{ t.prix_paye|floatformat:0 }} FCFA</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="fas fa-ticket-alt"></i>
                            <p>Aucun ticket trouvé</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.ticket-number { font-family: monospace; font-size: 11px; font-weight: 700; color: #28a745; }
</style>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    initDataTable('ticketsTable');
});
</script>
{% endblock %}