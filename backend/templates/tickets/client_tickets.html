{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Mes tickets{% endblock %}
{% block dashboard_css %}<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
.tab-btn{padding:8px 18px;border:none;background:none;border-bottom:2px solid transparent;font-size:13px;font-weight:600;color:var(--text-muted);cursor:pointer;transition:.15s;}
.tab-btn.active{color:var(--primary-green);border-bottom-color:var(--primary-green);}
.tab-pane{display:none;}.tab-pane.active{display:block;}
.ticket-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border-color);}
.ticket-row:last-child{border-bottom:none;}
.ticket-row:hover{background:var(--bg-light);}
.ticket-num{font-family:monospace;font-size:12px;font-weight:700;color:var(--primary-green);}
</style>
{% endblock %}

{% block sidebar_menu %}{% include 'dashboards/sidebars/client_sidebar.html' %}{% endblock %}

{% block page_content %}
<!-- Header -->
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
    <div>
        <h1 style="font-size:20px;font-weight:700;margin:0;color:var(--text-primary);">
            <i class="fas fa-ticket-alt" style="color:var(--primary-green);margin-right:8px;"></i>Mes tickets
        </h1>
        <p style="color:var(--text-muted);font-size:12px;margin:3px 0 0;">{{ debut_mois|date:"F Y" }}</p>
    </div>
    <a href="{% url 'tickets:client_qrcode' %}" class="btn btn-primary" style="font-size:13px;padding:8px 14px;">
        <i class="fas fa-qrcode"></i> Mon QR Code
    </a>
</div>

<!-- KPI compact -->
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;">
    <div style="background:white;border-radius:10px;padding:12px 14px;box-shadow:0 1px 4px rgba(0,0,0,.07);border-left:3px solid var(--primary-green);">
        <div style="font-size:10px;color:var(--text-muted);">Disponibles</div>
        <div style="font-size:24px;font-weight:800;color:var(--primary-green);">{{ nb_valides }}</div>
    </div>
    <div style="background:white;border-radius:10px;padding:12px 14px;box-shadow:0 1px 4px rgba(0,0,0,.07);border-left:3px solid #6c757d;">
        <div style="font-size:10px;color:var(--text-muted);">Consommés ce mois</div>
        <div style="font-size:24px;font-weight:800;color:#6c757d;">{{ nb_consommes_mois }}</div>
    </div>
    <div style="background:white;border-radius:10px;padding:12px 14px;box-shadow:0 1px 4px rgba(0,0,0,.07);border-left:3px solid #ffc107;">
        <div style="font-size:10px;color:var(--text-muted);">Expirés / Annulés</div>
        <div style="font-size:24px;font-weight:800;color:#ffc107;">{{ tickets_expires|length }}</div>
    </div>
</div>

<!-- Tabs -->
<div class="card" style="overflow:hidden;">
    <div style="display:flex;border-bottom:1px solid var(--border-color);padding:0 4px;">
        <button class="tab-btn active" onclick="showTab('valides',this)">
            <i class="fas fa-check-circle" style="color:var(--primary-green);margin-right:4px;"></i>Disponibles
            <span style="background:var(--light-green);color:var(--primary-green);border-radius:10px;padding:1px 7px;font-size:10px;margin-left:3px;">{{ nb_valides }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('consommes',this)">
            <i class="fas fa-flag-checkered" style="color:#6c757d;margin-right:4px;"></i>Consommés
            <span style="background:#f8f9fa;color:#6c757d;border-radius:10px;padding:1px 7px;font-size:10px;margin-left:3px;">{{ tickets_consommes|length }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('expires',this)">
            <i class="fas fa-times-circle" style="color:#ffc107;margin-right:4px;"></i>Expirés
        </button>
    </div>

    <!-- Tab: Disponibles -->
    <div class="tab-pane active" id="tab-valides">
        {% if tickets_valides %}
        {% for t in tickets_valides %}
        <div class="ticket-row">
            <div style="width:32px;height:32px;border-radius:8px;background:var(--light-green);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <i class="fas fa-ticket-alt" style="font-size:13px;color:var(--primary-green);"></i>
            </div>
            <div style="flex:1;min-width:0;">
                <div class="ticket-num">{{ t.numero_ticket }}</div>
                <div style="font-size:11px;color:var(--text-muted);">
                    Valide du {{ t.valide_de|date:"d/m" }} au {{ t.valide_jusqua|date:"d/m/Y" }}
                </div>
            </div>
            <div style="text-align:right;flex-shrink:0;">
                <span class="badge badge-success" style="font-size:10px;">Disponible</span>
                <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">{{ t.prix_paye|floatformat:0 }} FCFA</div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div style="text-align:center;padding:36px;color:var(--text-muted);">
            <i class="fas fa-ticket-alt" style="font-size:36px;display:block;margin-bottom:12px;opacity:.2;"></i>
            Aucun ticket disponible ce mois
        </div>
        {% endif %}
    </div>

    <!-- Tab: Consommés -->
    <div class="tab-pane" id="tab-consommes">
        {% if tickets_consommes %}
        {% for t in tickets_consommes %}
        <div class="ticket-row">
            <div style="width:32px;height:32px;border-radius:8px;background:#f8f9fa;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <i class="fas fa-check" style="font-size:13px;color:#6c757d;"></i>
            </div>
            <div style="flex:1;min-width:0;">
                <div class="ticket-num" style="color:#6c757d;">{{ t.numero_ticket }}</div>
                <div style="font-size:11px;color:var(--text-muted);">
                    {{ t.date_consommation|date:"d/m/Y à H\hi" }}
                    {% if t.restaurant_consommateur %}
                    · <strong style="color:var(--text-secondary);">{{ t.restaurant_consommateur.nom }}</strong>
                    {% endif %}
                </div>
                {% if t.plat_nom %}
                <div style="font-size:11px;margin-top:2px;">
                    <i class="fas fa-utensils" style="color:var(--primary-green);font-size:9px;margin-right:3px;"></i>
                    <strong style="color:var(--primary-green);">{{ t.plat_nom }}</strong>
                </div>
                {% endif %}
            </div>
            <span class="badge" style="font-size:10px;background:#e9ecef;color:#6c757d;flex-shrink:0;">Consommé</span>
        </div>
        {% endfor %}
        {% else %}
        <div style="text-align:center;padding:36px;color:var(--text-muted);">
            <i class="fas fa-inbox" style="font-size:36px;display:block;margin-bottom:12px;opacity:.2;"></i>
            Aucun ticket consommé
        </div>
        {% endif %}
    </div>

    <!-- Tab: Expirés -->
    <div class="tab-pane" id="tab-expires">
        {% if tickets_expires %}
        {% for t in tickets_expires %}
        <div class="ticket-row">
            <div style="width:32px;height:32px;border-radius:8px;background:#fff3cd;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <i class="fas fa-times" style="font-size:13px;color:#ffc107;"></i>
            </div>
            <div style="flex:1;min-width:0;">
                <div class="ticket-num" style="color:#adb5bd;">{{ t.numero_ticket }}</div>
                <div style="font-size:11px;color:var(--text-muted);">Expiré le {{ t.valide_jusqua|date:"d/m/Y" }}</div>
            </div>
            <span class="badge badge-warning" style="font-size:10px;flex-shrink:0;">{{ t.get_statut_display }}</span>
        </div>
        {% endfor %}
        {% else %}
        <div style="text-align:center;padding:36px;color:var(--text-muted);">
            <i class="fas fa-check-circle" style="font-size:36px;display:block;margin-bottom:12px;opacity:.2;color:var(--primary-green);"></i>
            Aucun ticket expiré
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
function showTab(name, btn) {
    document.querySelectorAll('.tab-pane').forEach(function(p){p.classList.remove('active');});
    document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active');});
    document.getElementById('tab-'+name).classList.add('active');
    btn.classList.add('active');
}
</script>
{% endblock %}