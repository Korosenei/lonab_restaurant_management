{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
.vente-container { max-width:800px;margin:0 auto; }
.step { background:white;border-radius:12px;padding:24px;box-shadow:0 1px 8px rgba(0,0,0,.06);margin-bottom:20px;border-left:4px solid var(--primary-green); }
.step-num { width:28px;height:28px;background:var(--primary-green);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0; }
.client-opt { display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:.15s;border:1px solid transparent; }
.client-opt:hover,.client-opt.selected { background:var(--light-green);border-color:var(--primary-green); }
.ticket-display { font-size:48px;font-weight:900;color:var(--primary-green);text-align:center;line-height:1; }
.recap-line { display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);font-size:14px; }
.recap-line:last-child { border:none;font-weight:700;font-size:16px;color:var(--primary-green); }
</style>
{% endblock %}

{% block sidebar_menu %}{% include 'dashboards/sidebars/caissier_sidebar.html' %}{% endblock %}

{% block page_content %}
<div id="page-urls"
     data-confirmer-url="{% url 'transactions:caissier_confirmer_vente' %}"
     style="display:none;"></div>

<div class="vente-container">
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;">
        <a href="{% url 'accounts:caissier_dashboard' %}" class="btn btn-secondary" style="padding:8px 14px;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h1 style="font-size:22px;font-weight:700;color:var(--text-primary);margin:0;">
                <i class="fas fa-ticket-alt" style="color:var(--primary-green);margin-right:8px;"></i>Vente de tickets
            </h1>
            <p style="color:var(--text-muted);font-size:13px;margin:2px 0 0;">
                Validit√© : {{ debut_mois|date:"d/m/Y" }} ‚Üí {{ fin_mois|date:"d/m/Y" }}
            </p>
        </div>
    </div>

    <!-- √âtape 1 : S√©lectionner le client -->
    <div class="step">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div class="step-num">1</div>
            <h3 style="margin:0;font-size:15px;font-weight:700;">S√©lectionner le client</h3>
        </div>
        <!-- Recherche rapide -->
        <div style="position:relative;margin-bottom:12px;">
            <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);"></i>
            <input type="text" id="clientSearch" placeholder="Matricule, nom, pr√©nom..."
                   style="padding:10px 10px 10px 36px;border:1px solid var(--border-color);border-radius:8px;width:100%;box-sizing:border-box;font-size:14px;"
                   oninput="filtrerClients(this.value)">
        </div>
        <div id="clientList" style="max-height:240px;overflow-y:auto;border:1px solid var(--border-color);border-radius:8px;">
            {% for c in clients %}
            <div class="client-opt" data-id="{{ c.id }}" data-nom="{{ c.get_full_name|escapejs }}"
                 data-matricule="{{ c.matricule|default:'' }}"
                 data-agence="{{ c.agence.nom|default:'‚Äî' }}"
                 onclick="selectClient(this)"
                 style="search-key:{{ c.prenom|lower }} {{ c.nom|lower }} {{ c.matricule|lower }};">
                <div style="width:34px;height:34px;border-radius:50%;background:var(--light-green);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary-green);font-size:12px;flex-shrink:0;">
                    {{ c.prenom.0 }}{{ c.nom.0 }}
                </div>
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:13px;">{{ c.get_full_name }}</div>
                    <div style="font-size:11px;color:var(--text-muted);">{{ c.matricule|default:"‚Äî" }} ¬∑ {{ c.agence.nom|default:"‚Äî" }}</div>
                </div>
                <div id="badge_{{ c.id }}" style="font-size:11px;"></div>
            </div>
            {% empty %}
            <div style="padding:20px;text-align:center;color:var(--text-muted);">Aucun client actif</div>
            {% endfor %}
        </div>
        <input type="hidden" id="selectedClientId">
        <div id="clientInfo" style="display:none;margin-top:12px;padding:12px;background:var(--light-green);border-radius:8px;font-size:13px;"></div>
    </div>

    <!-- √âtape 2 : Nombre de tickets -->
    <div class="step">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <div class="step-num">2</div>
            <h3 style="margin:0;font-size:15px;font-weight:700;">Nombre de tickets</h3>
            <span style="margin-left:auto;font-size:12px;color:var(--text-muted);">Min: {{ min_tickets }} ‚Äî Max: {{ max_tickets }}</span>
        </div>
        <div class="ticket-display" id="nbDisplay">22</div>
        <div style="display:flex;align-items:center;gap:12px;margin-top:20px;justify-content:center;">
            <button onclick="changeNb(-5)" class="btn btn-secondary" style="width:44px;height:44px;padding:0;font-size:18px;border-radius:50%;">-5</button>
            <button onclick="changeNb(-1)" class="btn btn-secondary" style="width:44px;height:44px;padding:0;font-size:22px;border-radius:50%;">-</button>
            <input type="number" id="nbTickets" value="{{ max_tickets }}" min="{{ min_tickets }}" max="{{ max_tickets }}"
                   style="width:80px;padding:10px;text-align:center;border:1px solid var(--border-color);border-radius:8px;font-size:18px;font-weight:700;"
                   oninput="majRecap()">
            <button onclick="changeNb(1)" class="btn btn-primary" style="width:44px;height:44px;padding:0;font-size:22px;border-radius:50%;">+</button>
            <button onclick="changeNb(5)" class="btn btn-primary" style="width:44px;height:44px;padding:0;font-size:18px;border-radius:50%;">+5</button>
        </div>
        <!-- Boutons rapides - Solution 2 : hardcod√©s -->
        <div style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
            <button onclick="setNb(5)" class="btn btn-secondary" style="padding:6px 16px;border-radius:20px;">5</button>
            <button onclick="setNb(10)" class="btn btn-secondary" style="padding:6px 16px;border-radius:20px;">10</button>
            <button onclick="setNb(15)" class="btn btn-secondary" style="padding:6px 16px;border-radius:20px;">15</button>
            <button onclick="setNb(22)" class="btn btn-secondary" style="padding:6px 16px;border-radius:20px;">22</button>
        </div>
    </div>

    <!-- √âtape 3 : Paiement -->
    <div class="step">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div class="step-num">3</div>
            <h3 style="margin:0;font-size:15px;font-weight:700;">Mode de paiement</h3>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
                <label style="font-size:13px;color:var(--text-muted);display:block;margin-bottom:6px;">Mode <span style="color:red">*</span></label>
                <select id="modePaiement" class="form-control">
                    <option value="ESPECES">üíµ Esp√®ces</option>
                    <option value="MOBILE">üì± Mobile Money</option>
                    <option value="CARTE">üí≥ Carte bancaire</option>
                    <option value="VIREMENT">üè¶ Virement</option>
                </select>
            </div>
            <div>
                <label style="font-size:13px;color:var(--text-muted);display:block;margin-bottom:6px;">R√©f√©rence paiement</label>
                <input type="text" id="refPaiement" class="form-control" placeholder="N¬∞ re√ßu, r√©f√©rence...">
            </div>
            <div style="grid-column:1/-1;">
                <label style="font-size:13px;color:var(--text-muted);display:block;margin-bottom:6px;">Notes</label>
                <input type="text" id="notes" class="form-control" placeholder="Notes optionnelles...">
            </div>
        </div>
    </div>

    <!-- R√©capitulatif -->
    <div class="card" style="padding:20px;margin-bottom:20px;">
        <h3 style="font-size:15px;font-weight:700;margin:0 0 16px;">R√©capitulatif</h3>
        <div class="recap-line"><span>Nombre de tickets</span><span id="r_nb" style="font-weight:600;">22</span></div>
        <div class="recap-line"><span>Prix unitaire (part employ√©)</span><span>{{ prix_ticket|floatformat:0 }} FCFA</span></div>
        <div class="recap-line"><span>Subvention employeur</span><span>{{ subvention|floatformat:0 }} FCFA √ó <span id="r_nb2">22</span></span></div>
        <div class="recap-line"><span>P√©riode de validit√©</span><span>{{ debut_mois|date:"d/m" }} ‚Üí {{ fin_mois|date:"d/m/Y" }}</span></div>
        <div class="recap-line"><span>Montant √† encaisser</span><span id="r_total">11 000 FCFA</span></div>
    </div>

    <button id="btnVendre" onclick="confirmerVente()"
            class="btn btn-primary" style="width:100%;padding:16px;font-size:16px;font-weight:700;" disabled>
        <i class="fas fa-check-circle"></i> Confirmer la vente
    </button>
</div>

<!-- Modal succ√®s -->
<div class="modal-overlay" id="successModal">
    <div class="modal" style="max-width:420px;width:100%;text-align:center;">
        <div style="padding:32px 24px;">
            <div style="width:72px;height:72px;background:#e8f5e9;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:36px;color:var(--primary-green);">‚úì</div>
            <h2 style="font-size:20px;font-weight:800;color:var(--text-primary);margin:0 0 8px;">Vente confirm√©e !</h2>
            <p id="successMsg" style="color:var(--text-muted);margin:0 0 16px;font-size:14px;"></p>
            <div style="background:var(--bg-light);border-radius:8px;padding:12px;margin-bottom:20px;font-size:13px;text-align:left;">
                <div><strong>N¬∞ Transaction :</strong> <span id="s_numero"></span></div>
                <div style="margin-top:4px;"><strong>Tickets :</strong> <span id="s_tickets"></span></div>
            </div>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button onclick="location.href='{% url 'transactions:caissier_vente' %}'" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nouvelle vente
                </button>
                <button onclick="location.href='{% url 'transactions:caissier_dashboard' %}'" class="btn btn-secondary">
                    Dashboard
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
var urls      = document.getElementById('page-urls').dataset;
var PRIX      = {{ prix_ticket }};
var MIN_T     = {{ min_tickets }};
var MAX_T     = {{ max_tickets }};

function filtrerClients(val) {
    val = val.toLowerCase();
    document.querySelectorAll('.client-opt').forEach(function(el) {
        var key = (el.dataset.nom + ' ' + el.dataset.matricule).toLowerCase();
        el.style.display = key.includes(val) ? '' : 'none';
    });
}

function selectClient(el) {
    document.querySelectorAll('.client-opt').forEach(function(e) { e.classList.remove('selected'); });
    el.classList.add('selected');
    document.getElementById('selectedClientId').value = el.dataset.id;
    var info = document.getElementById('clientInfo');
    info.innerHTML = '<i class="fas fa-user-check" style="color:var(--primary-green);margin-right:8px;"></i>' +
        '<strong>' + el.dataset.nom + '</strong>' +
        (el.dataset.matricule ? ' ‚Äî Matricule: ' + el.dataset.matricule : '') +
        ' ‚Äî Agence: ' + el.dataset.agence;
    info.style.display = 'block';
    updateBtn();
}

function changeNb(delta) {
    var el = document.getElementById('nbTickets');
    var v  = Math.min(MAX_T, Math.max(MIN_T, parseInt(el.value || MIN_T) + delta));
    el.value = v;
    majRecap();
}

function setNb(n) {
    document.getElementById('nbTickets').value = n;
    majRecap();
}

function majRecap() {
    var nb = parseInt(document.getElementById('nbTickets').value) || 0;
    nb = Math.min(MAX_T, Math.max(MIN_T, nb));
    document.getElementById('nbTickets').value = nb;
    document.getElementById('nbDisplay').textContent = nb;
    document.getElementById('r_nb').textContent  = nb;
    document.getElementById('r_nb2').textContent = nb;
    document.getElementById('r_total').textContent = (nb * PRIX).toLocaleString('fr-FR') + ' FCFA';
    updateBtn();
}

function updateBtn() {
    var clientOk = !!document.getElementById('selectedClientId').value;
    var nbOk     = parseInt(document.getElementById('nbTickets').value) >= MIN_T;
    document.getElementById('btnVendre').disabled = !(clientOk && nbOk);
}

function confirmerVente() {
    var clientId = document.getElementById('selectedClientId').value;
    if (!clientId) { showToast('S√©lectionnez un client', 'warning'); return; }
    var nb = parseInt(document.getElementById('nbTickets').value);
    if (nb < MIN_T || nb > MAX_T) { showToast('Nombre de tickets invalide', 'warning'); return; }

    document.getElementById('btnVendre').disabled = true;
    document.getElementById('btnVendre').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';

    var fd = new FormData();
    fd.append('client_id',       clientId);
    fd.append('nombre_tickets',  nb);
    fd.append('mode_paiement',   document.getElementById('modePaiement').value);
    fd.append('reference_paiement', document.getElementById('refPaiement').value);
    fd.append('notes',           document.getElementById('notes').value);

    fetch(urls.confirmerUrl, { method: 'POST', headers: {'X-CSRFToken': getCsrfToken()}, body: fd })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.success) {
                document.getElementById('successMsg').textContent  = d.message;
                document.getElementById('s_numero').textContent   = d.numero;
                document.getElementById('s_tickets').textContent  = d.premier_ticket + ' ‚Üí ' + d.dernier_ticket;
                openModal('successModal');
            } else {
                showToast(d.error, 'error');
                document.getElementById('btnVendre').disabled = false;
                document.getElementById('btnVendre').innerHTML = '<i class="fas fa-check-circle"></i> Confirmer la vente';
            }
        });
}

// Init
majRecap();
</script>
{% endblock %}