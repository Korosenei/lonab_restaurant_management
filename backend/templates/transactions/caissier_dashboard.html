{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block title %}Tableau de bord — Caissier{% endblock %}
{% block dashboard_css %}<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
.stat-card {
    display:flex; align-items:center; justify-content:space-between;
    background:white; border-radius:12px; padding:20px;
    box-shadow:0 1px 6px rgba(0,0,0,.07);
}
.stat-icon {
    width:50px; height:50px; border-radius:50%;
    display:flex; align-items:center; justify-content:center; font-size:22px; flex-shrink:0;
}
.qr-wrap {
    background:linear-gradient(135deg,#1a472a 0%,#2d6a4f 100%);
    border-radius:14px; padding:22px; color:white; text-align:center;
}
.qr-frame {
    width:180px; height:180px; background:white; border-radius:12px;
    margin:14px auto; padding:10px; box-sizing:border-box;
    box-shadow:0 4px 16px rgba(0,0,0,.25);
    display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.qr-frame img { width:100%; height:100%; object-fit:contain; border-radius:6px; }
.timer-display {
    font-size:32px; font-weight:900; letter-spacing:2px;
    margin:6px 0; font-variant-numeric:tabular-nums;
}
.btn-regen {
    display:inline-flex; align-items:center; gap:6px;
    padding:9px 18px; border-radius:8px; font-size:13px; font-weight:700;
    background:rgba(255,255,255,.15); color:white;
    border:1px solid rgba(255,255,255,.4); cursor:pointer; transition:.2s; margin-top:10px;
}
.btn-regen:hover { background:rgba(255,255,255,.25); }
.btn-regen:disabled { opacity:.6; cursor:not-allowed; }
</style>
{% endblock %}

{% block sidebar_menu %}{% include 'dashboards/sidebars/caissier_sidebar.html' %}{% endblock %}

{% block page_content %}
<div id="page-urls"
     data-regen-url="# url 'transactions:caissier_regenerer_qr' %}"
     style="display:none;"></div>

<!-- En-tête -->
<div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:24px;">
    <div>
        <h1 style="font-size:22px;font-weight:700;color:var(--text-primary);margin:0;">
            <i class="fas fa-cash-register" style="color:var(--primary-green);margin-right:10px;"></i>
            Tableau de bord — Caissier
        </h1>
        <p style="color:var(--text-muted);font-size:13px;margin:4px 0 0;">
            {% if user.agence %}{{ user.agence.nom }}{% else %}Toutes les agences{% endif %} ·
            {{ aujourd_hui|date:"l d F Y" }}
        </p>
    </div>
    <div style="display:flex;gap:8px;">
        <a href="{% url 'tickets:caissier_tickets' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Vendre des tickets
        </a>
        <a href="{% url 'restaurants:caissier_planifier' %}" class="btn btn-outline">
            <i class="fas fa-calendar-plus"></i> Programmations
        </a>
    </div>
</div>

<!-- ═══ Stats Cards ════════════════════════════════════════════ -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:14px;margin-bottom:24px;">

    <div class="stat-card" style="border-left:4px solid var(--primary-green);">
        <div>
            <div style="color:var(--text-muted);font-size:12px;margin-bottom:4px;">Ventes du jour</div>
            <div style="font-size:30px;font-weight:800;color:var(--primary-green);">{{ stats.aujourd_hui }}</div>
            <div style="font-size:11px;color:var(--text-muted);">transactions</div>
        </div>
        <div class="stat-icon" style="background:var(--light-green);">
            <i class="fas fa-cash-register" style="color:var(--primary-green);"></i>
        </div>
    </div>

    <div class="stat-card" style="border-left:4px solid #17a2b8;">
        <div>
            <div style="color:var(--text-muted);font-size:12px;margin-bottom:4px;">Tickets vendus ce mois</div>
            <div style="font-size:30px;font-weight:800;color:#17a2b8;">{{ stats.tickets_mois }}</div>
            <div style="font-size:11px;color:var(--text-muted);">tickets</div>
        </div>
        <div class="stat-icon" style="background:#d1ecf1;">
            <i class="fas fa-ticket-alt" style="color:#17a2b8;"></i>
        </div>
    </div>

    <div class="stat-card" style="border-left:4px solid #28a745;">
        <div>
            <div style="color:var(--text-muted);font-size:12px;margin-bottom:4px;">CA du mois</div>
            <div style="font-size:30px;font-weight:800;color:#28a745;">{{ stats.ca_mois|floatformat:0 }}</div>
            <div style="font-size:11px;color:var(--primary-green);">FCFA</div>
        </div>
        <div class="stat-icon" style="background:var(--light-green);">
            <i class="fas fa-coins" style="color:#28a745;"></i>
        </div>
    </div>

    <div class="stat-card" style="border-left:4px solid #ffc107;">
        <div>
            <div style="color:var(--text-muted);font-size:12px;margin-bottom:4px;">En attente</div>
            <div style="font-size:30px;font-weight:800;color:#ffc107;">{{ stats.en_attente }}</div>
            <div style="font-size:11px;color:var(--text-muted);">transactions</div>
        </div>
        <div class="stat-icon" style="background:#fff3cd;">
            <i class="fas fa-hourglass-half" style="color:#ffc107;"></i>
        </div>
    </div>
</div>

<!-- ═══ Graphe 30j + Mon QR Code ═══════════════════════════════ -->
<div style="display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-bottom:18px;">

    <!-- Graphe activité 30 jours -->
    <div class="card" style="padding:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <h3 style="font-size:15px;font-weight:700;margin:0;">
                <i class="fas fa-chart-bar" style="color:var(--primary-green);margin-right:8px;"></i>
                Tickets vendus — 30 derniers jours
            </h3>
            <a href="{% url 'transactions:caissier_historique' %}" style="font-size:12px;color:var(--primary-green);">
                Historique →
            </a>
        </div>
        <canvas id="barChart7j" height="120"></canvas>
    </div>

    <!-- Mon QR Code -->
    <div class="qr-wrap">
        <div style="font-size:13px;font-weight:700;opacity:.85;text-transform:uppercase;letter-spacing:.5px;">
            <i class="fas fa-qrcode"></i>&nbsp; Mon QR Code
        </div>

        <!-- Image QR -->
        <div class="qr-frame" id="qrFrame">
            {% if qr_caissier and qr_caissier.image_qr %}
            <img src="{{ qr_caissier.image_qr.url }}" alt="QR Code" id="qrImage">
            {% else %}
            <div style="text-align:center;color:#adb5bd;">
                <i class="fas fa-qrcode" style="font-size:60px;display:block;margin-bottom:8px;"></i>
                <div style="font-size:11px;">Génération...</div>
            </div>
            {% endif %}
        </div>

        <!-- Timer expiration -->
        <div class="timer-display" id="timerDisplay"
             style="display:{% if qr_caissier %}block{% else %}none{% endif %};">
            --:--
        </div>
        {% if qr_caissier %}
        <div style="font-size:11px;opacity:.7;">Expire dans</div>
        {% endif %}

        <button class="btn-regen" id="btnRegen" onclick="regenererQR()">
            <i class="fas fa-sync-alt" id="regenIcon"></i>
            Régénérer
        </button>

        <div style="font-size:11px;opacity:.6;margin-top:8px;line-height:1.5;">
            Votre QR code personnel d'identification
        </div>
    </div>
</div>

<!-- ═══ Transactions récentes ════════════════════════════════════ -->
<div class="card" style="overflow:hidden;">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border-color);
                display:flex;align-items:center;justify-content:space-between;">
        <h3 style="font-size:15px;font-weight:700;margin:0;">
            <i class="fas fa-receipt" style="color:var(--primary-green);margin-right:8px;"></i>
            Transactions récentes
        </h3>
        <a href="{% url 'transactions:caissier_historique' %}" class="btn btn-outline"
           style="font-size:11px;padding:5px 12px;">
            Voir tout →
        </a>
    </div>
    {% if recentes %}
    <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
            <thead>
                <tr style="background:var(--bg-light);border-bottom:2px solid var(--border-color);">
                    <th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">N° Transaction</th>
                    <th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Client</th>
                    <th style="padding:10px 16px;text-align:center;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Tickets</th>
                    <th style="padding:10px 16px;text-align:right;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Montant</th>
                    <th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Date</th>
                    <th style="padding:10px 16px;text-align:center;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for t in recentes %}
                <tr style="border-bottom:1px solid var(--border-color);"
                    onmouseover="this.style.background='var(--bg-light)'"
                    onmouseout="this.style.background=''">
                    <td style="padding:12px 16px;font-size:11px;font-family:monospace;
                               color:var(--primary-green);font-weight:700;">
                        {{ t.numero_transaction|truncatechars:16 }}
                    </td>
                    <td style="padding:12px 16px;font-size:13px;font-weight:600;color:var(--text-primary);">
                        {{ t.client.get_full_name|truncatechars:22 }}
                    </td>
                    <td style="padding:12px 16px;text-align:center;font-size:13px;">
                        {{ t.nombre_tickets }}
                    </td>
                    <td style="padding:12px 16px;text-align:right;font-size:13px;font-weight:600;">
                        {{ t.montant_total|floatformat:0 }}
                        <span style="font-size:10px;color:var(--text-muted);">FCFA</span>
                    </td>
                    <td style="padding:12px 16px;font-size:11px;color:var(--text-muted);">
                        {{ t.date_transaction|date:"d/m/Y H:i" }}
                    </td>
                    <td style="padding:12px 16px;text-align:center;">
                        <span class="badge
                            {% if t.statut == 'TERMINEE' %}badge-success
                            {% elif t.statut == 'EN_ATTENTE' %}badge-warning
                            {% else %}badge-danger{% endif %}"
                            style="font-size:10px;">
                            {{ t.get_statut_display }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align:center;padding:48px;color:var(--text-muted);">
        <i class="fas fa-inbox" style="font-size:40px;display:block;margin-bottom:14px;opacity:.25;"></i>
        Aucune transaction pour le moment
    </div>
    {% endif %}
</div>

<!-- Données Chart.js (pas json_script, injection inline) -->
<script id="graphData7j" type="application/json">
[{% for d in graph_7j %}{"label":"{{ d.label }}","value":{{ d.value }}}{% if not forloop.last %},{% endif %}{% endfor %}]
</script>
{% if qr_caissier %}
<script id="qrExpiryData" type="application/json">"{{ qr_caissier.expire_le|date:'c' }}"</script>
{% endif %}
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
(function () {
'use strict';
Chart.defaults.font.family = "'Inter','Segoe UI',sans-serif";
Chart.defaults.font.size   = 12;

/* ── Graphe barres 30 jours ────────────────────────────────── */
var raw7j = JSON.parse(document.getElementById('graphData7j').textContent);
new Chart(document.getElementById('barChart7j'), {
    type: 'bar',
    data: {
        labels:   raw7j.map(function(d) { return d.label; }),
        datasets: [{
            label: 'Tickets vendus',
            data:  raw7j.map(function(d) { return d.value; }),
            backgroundColor: 'rgba(40,167,69,.18)',
            borderColor:     '#28a745',
            borderWidth:     2,
            borderRadius:    4,
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1, precision: 0 },
                grid:  { color: 'rgba(0,0,0,.04)' }
            },
            x: {
                grid: { display: false },
                ticks: {
                    maxTicksLimit: 10,
                    maxRotation: 0,
                    font: { size: 10 }
                }
            }
        }
    }
});

/* ── QR Code — timer expiration ────────────────────────────── */
var expiryEl = document.getElementById('qrExpiryData');
var timerEl  = document.getElementById('timerDisplay');
var timerInt = null;
var expiry   = null;

function majTimer() {
    if (!expiry || !timerEl) return;
    var diff = Math.max(0, Math.floor((expiry - new Date()) / 1000));
    if (diff === 0) {
        timerEl.textContent = 'Expiré';
        timerEl.style.color = '#fca5a5';
        clearInterval(timerInt);
        return;
    }
    var m = Math.floor(diff / 60), s = diff % 60;
    timerEl.textContent = (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
    timerEl.style.color = diff < 120 ? '#fca5a5' : 'white';
}

if (expiryEl && timerEl) {
    expiry = new Date(JSON.parse(expiryEl.textContent));
    timerEl.style.display = 'block';
    majTimer();
    timerInt = setInterval(majTimer, 1000);
}

/* ── Régénérer QR ───────────────────────────────────────────── */
var regenUrl = document.getElementById('page-urls').dataset.regenUrl;

window.regenererQR = function () {
    var btn  = document.getElementById('btnRegen');
    var icon = document.getElementById('regenIcon');
    btn.disabled   = true;
    icon.className = 'fas fa-spinner fa-spin';

    fetch(regenUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCsrfToken() }
    })
    .then(function (r) { return r.json(); })
    .then(function (d) {
        btn.disabled   = false;
        icon.className = 'fas fa-sync-alt';
        if (d.success) {
            showSuccess(d.message || 'QR Code régénéré');
            if (d.image_url) {
                document.getElementById('qrFrame').innerHTML =
                    '<img src="' + d.image_url + '" alt="QR Code" ' +
                    'style="width:100%;height:100%;object-fit:contain;border-radius:6px;">';
            }
            if (d.expire_le && timerEl) {
                expiry = new Date(d.expire_le);
                timerEl.style.display = 'block';
                clearInterval(timerInt);
                majTimer();
                timerInt = setInterval(majTimer, 1000);
            } else {
                setTimeout(function () { location.reload(); }, 800);
            }
        } else {
            showError(d.error || 'Erreur lors de la régénération');
        }
    })
    .catch(function () {
        btn.disabled   = false;
        icon.className = 'fas fa-sync-alt';
        showError('Erreur réseau');
    });
};

})();
</script>
{% endblock %}