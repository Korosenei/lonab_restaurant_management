{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">{% endblock %}
{% block sidebar_menu %}{% include 'dashboards/sidebars/caissier_sidebar.html' %}{% endblock %}

{% block page_content %}
<div id="page-urls"
     data-detail-base="{% url 'transactions:caissier_client_detail' pk=0 %}"
     data-vente-url="# url 'transactions:caissier_vente' %}"
     style="display:none;"></div>

<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
    <h1 style="font-size:22px;font-weight:700;color:var(--text-primary);margin:0;">
        <i class="fas fa-users" style="color:var(--primary-green);margin-right:10px;"></i>Clients
    </h1>
    <a href="# url 'transactions:caissier_vente' %}" class="btn btn-primary">
        <i class="fas fa-ticket-alt"></i> Vendre des tickets
    </a>
</div>

<!-- Recherche -->
<div class="card" style="padding:14px 16px;margin-bottom:18px;">
    <form method="get" style="display:flex;gap:12px;align-items:flex-end;">
        <div style="flex:1;">
            <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Recherche</label>
            <div style="position:relative;">
                <i class="fas fa-search"
                   style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);"></i>
                <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Nom, matricule, email..."
                       style="padding:8px 8px 8px 32px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;width:100%;box-sizing:border-box;">
            </div>
        </div>
        <button type="submit" class="btn btn-secondary">Rechercher</button>
    </form>
</div>

<div class="card" style="overflow:hidden;">
    <table style="width:100%;border-collapse:collapse;">
        <thead>
        <tr style="background:var(--bg-light);border-bottom:2px solid var(--border-color);">
            <th style="padding:12px 16px;text-align:left;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">
                Client
            </th>
            <th style="padding:12px 16px;text-align:left;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">
                Agence / Direction
            </th>
            <th style="padding:12px 16px;text-align:center;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">
                Tickets valides
            </th>
            <th style="padding:12px 16px;text-align:right;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">
                Actions
            </th>
        </tr>
        </thead>
        <tbody>
        {% for c in clients %}
        <tr style="border-top:1px solid var(--border-color);"
            onmouseover="this.style.background='var(--bg-light)'" onmouseout="this.style.background=''">
            <td style="padding:14px 16px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="width:36px;height:36px;border-radius:50%;background:var(--light-green);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary-green);font-size:13px;flex-shrink:0;">
                        {% if c.photo_profil %}
                        <img src="{{ c.photo_profil.url }}"
                             style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                        {% else %}
                        {{ c.prenom.0 }}{{ c.nom.0 }}
                        {% endif %}
                    </div>
                    <div>
                        <div style="font-weight:600;font-size:13px;color:var(--text-primary);">{{ c.get_full_name }}
                        </div>
                        <div style="font-size:11px;color:var(--text-muted);">{{ c.matricule|default:"—" }} · {{ c.email
                            }}
                        </div>
                    </div>
                </div>
            </td>
            <td style="padding:14px 16px;">
                <div style="font-size:13px;color:var(--text-secondary);">{{ c.agence.nom|default:"—" }}</div>
                <div style="font-size:11px;color:var(--text-muted);">{{ c.direction.nom|default:"—" }}</div>
            </td>
            <td style="padding:14px 16px;text-align:center;">
                {% with nb=c.tickets_disponibles %}
                <span style="font-weight:700;font-size:16px;color:{% if nb > 0 %}var(--primary-green){% else %}#dc3545{% endif %};">
        {{ nb }}
    </span>
                {% endwith %}
            </td>
            <td style="padding:14px 16px;text-align:right;">
                <div style="display:flex;gap:6px;justify-content:flex-end;">
                    <button onclick="voirClient({{ c.id }})" class="btn-icon" title="Détail"><i class="fas fa-eye"></i>
                    </button>
                    <button onclick="vendrePour({{ c.id }})" class="btn btn-primary"
                            style="padding:5px 12px;font-size:12px;">
                        <i class="fas fa-ticket-alt"></i> Vendre
                    </button>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4" style="text-align:center;padding:48px;color:var(--text-muted);">
                <i class="fas fa-users" style="font-size:32px;opacity:.3;display:block;margin-bottom:12px;"></i>
                Aucun client actif trouvé
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
    var urls = document.getElementById('page-urls').dataset;
    function voirClient(id)  { window.location.href = urls.detailBase.replace('/0/', '/' + id + '/'); }
    function vendrePour(id)  { window.location.href = urls.venteUrl + '?client_id=' + id; }
</script>
{% endblock %}