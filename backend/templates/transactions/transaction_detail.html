{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block dashboard_css %}<link rel="stylesheet" href="{% static 'css/components.css' %}">{% endblock %}

{% block sidebar_menu %}
{% if request.user.est_super_admin %}{% include 'dashboards/sidebars/admin_sidebar.html' %}
{% elif request.user.est_caissier %}{% include 'dashboards/sidebars/caissier_sidebar.html' %}
{% else %}{% include 'dashboards/sidebars/client_sidebar.html' %}{% endif %}
{% endblock %}

{% block page_content %}
<div id="page-urls"
     data-rembourser-url="{% url 'transactions:rembourser' transaction.id %}"
     style="display:none;"></div>

<div style="display:flex;align-items:center;gap:14px;margin-bottom:24px;">
    <a onclick="history.back()" class="btn btn-secondary" style="padding:8px 14px;cursor:pointer;"><i class="fas fa-arrow-left"></i></a>
    <div>
        <h1 style="font-size:20px;font-weight:700;color:var(--text-primary);margin:0;">
            <i class="fas fa-receipt" style="color:var(--primary-green);margin-right:8px;"></i>
            Transaction {{ transaction.numero_transaction }}
        </h1>
        <p style="color:var(--text-muted);font-size:13px;margin:2px 0 0;">{{ transaction.date_transaction|date:"d F Y à H:i" }}</p>
    </div>
    {% if transaction.statut == 'TERMINEE' %}<span class="badge badge-success" style="margin-left:auto;padding:6px 14px;font-size:13px;">Complété</span>
    {% elif transaction.statut == 'EN_ATTENTE' %}<span class="badge badge-warning" style="margin-left:auto;padding:6px 14px;font-size:13px;">En attente</span>
    {% elif transaction.statut == 'REMBOURSE' %}<span class="badge" style="background:#6c757d;color:white;margin-left:auto;padding:6px 14px;font-size:13px;">Remboursé</span>
    {% else %}<span class="badge badge-danger" style="margin-left:auto;padding:6px 14px;font-size:13px;">Échoué</span>{% endif %}
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
    <!-- Infos transaction -->
    <div class="card" style="padding:20px;">
        <h3 style="font-size:14px;font-weight:700;margin:0 0 16px;color:var(--text-primary);">Détails de la transaction</h3>
        <div style="display:flex;flex-direction:column;gap:10px;">
            {% for label, val in info_lines %}
            <div style="display:flex;justify-content:space-between;font-size:13px;">
                <span style="color:var(--text-muted);">{{ label }}</span>
                <span style="font-weight:600;">{{ val }}</span>
            </div>
            {% empty %}
            <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text-muted);">Client</span><span style="font-weight:600;">{{ transaction.client.get_full_name }}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text-muted);">Matricule</span><span style="font-weight:600;">{{ transaction.client.matricule|default:"—" }}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text-muted);">Caissier</span><span style="font-weight:600;">{{ transaction.caissier.get_full_name|default:"—" }}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text-muted);">Agence</span><span style="font-weight:600;">{{ transaction.agence.nom|default:"—" }}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text-muted);">Mode de paiement</span><span style="font-weight:600;">{{ transaction.get_mode_paiement_display }}</span></div>
            {% if transaction.reference_paiement %}
            <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text-muted);">Référence</span><span style="font-weight:600;">{{ transaction.reference_paiement }}</span></div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Montants -->
    <div class="card" style="padding:20px;">
        <h3 style="font-size:14px;font-weight:700;margin:0 0 16px;color:var(--text-primary);">Récapitulatif financier</h3>
        <div style="display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;justify-content:space-between;font-size:13px;padding-bottom:8px;border-bottom:1px solid var(--border-color);">
                <span style="color:var(--text-muted);">Nombre de tickets</span>
                <span style="font-weight:700;color:var(--primary-green);font-size:16px;">{{ transaction.nombre_tickets }}</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:13px;">
                <span style="color:var(--text-muted);">Prix unitaire</span>
                <span style="font-weight:600;">{{ transaction.prix_unitaire|floatformat:0 }} FCFA</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:13px;">
                <span style="color:var(--text-muted);">Subvention / ticket</span>
                <span style="font-weight:600;">{{ transaction.subvention_par_ticket|floatformat:0 }} FCFA</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:13px;">
                <span style="color:var(--text-muted);">Subvention totale</span>
                <span style="font-weight:600;">{{ transaction.subvention_totale|floatformat:0 }} FCFA</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:14px;padding-top:8px;border-top:2px solid var(--primary-green);margin-top:4px;">
                <span style="font-weight:700;color:var(--text-primary);">Montant encaissé</span>
                <span style="font-weight:800;color:var(--primary-green);font-size:18px;">{{ transaction.montant_total|floatformat:0 }} FCFA</span>
            </div>
        </div>
        <div style="margin-top:12px;padding:10px;background:var(--bg-light);border-radius:8px;font-size:12px;color:var(--text-muted);">
            Validité : {{ transaction.valide_de|date:"d/m/Y" }} → {{ transaction.valide_jusqu_a|date:"d/m/Y" }}
        </div>
        {% if peut_rembourser %}
        <button onclick="rembourser()" class="btn" style="width:100%;margin-top:16px;background:#dc3545;color:white;padding:10px;">
            <i class="fas fa-undo"></i> Rembourser la transaction
        </button>
        {% endif %}
    </div>
</div>

<!-- Liste des tickets -->
<div class="card" style="overflow:hidden;">
    <div style="padding:14px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;">
        <h3 style="font-size:14px;font-weight:700;margin:0;"><i class="fas fa-ticket-alt" style="color:var(--primary-green);margin-right:8px;"></i>Tickets générés ({{ tickets.count }})</h3>
        <span style="font-size:12px;color:var(--text-muted);">{{ transaction.premier_ticket }} → {{ transaction.dernier_ticket }}</span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:0;">
        {% for t in tickets %}
        <div style="padding:10px 14px;border-right:1px solid var(--border-color);border-bottom:1px solid var(--border-color);">
            <div style="font-family:monospace;font-size:12px;font-weight:600;">{{ t.numero_ticket }}</div>
            <div>
                {% if t.statut == 'DISPONIBLE' %}<span class="badge badge-success" style="font-size:10px;">Disponible</span>
                {% elif t.statut == 'CONSOMME' %}<span class="badge badge-secondary" style="font-size:10px;background:#6c757d;">Consommé</span>
                {% elif t.statut == 'ANNULE' %}<span class="badge badge-danger" style="font-size:10px;">Annulé</span>
                {% else %}<span class="badge badge-warning" style="font-size:10px;">Expiré</span>{% endif %}
            </div>
            {% if t.date_consommation %}<div style="font-size:10px;color:var(--text-muted);margin-top:2px;">{{ t.date_consommation|date:"d/m H:i" }}</div>{% endif %}
        </div>
        {% empty %}
        <div style="padding:24px;text-align:center;color:var(--text-muted);grid-column:1/-1;">Aucun ticket généré</div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
var urls = document.getElementById('page-urls').dataset;
function rembourser() {
    showConfirm('Rembourser cette transaction ?',
        'Tous les tickets non consommés seront annulés. Cette action est irréversible.',
        function() {
            fetch(urls.rembourserUrl, { method:'POST', headers:{'X-CSRFToken':getCsrfToken()} })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.success) { showToast(d.message,'success'); setTimeout(function(){location.reload();},1000); }
                    else showToast(d.error,'error');
                });
        }, 'Confirmer le remboursement');
}
</script>
{% endblock %}